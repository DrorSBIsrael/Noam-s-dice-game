<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק הקוביות של נועם</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes diceRoll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(90deg) rotateY(90deg); }
            50% { transform: rotateX(180deg) rotateY(180deg); }
            75% { transform: rotateX(270deg) rotateY(270deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        
        .dice-roll {
            animation: diceRoll 0.1s linear infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 255, 0, 0.8); }
        }
        
        .player-glow {
            animation: glow 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Simple SVG icons instead of lucide
        const VolumeIcon = ({ enabled }) => (
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            {enabled && <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>}
            {!enabled && <line x1="23" y1="9" x2="17" y2="15"></line>}
            {!enabled && <line x1="17" y1="9" x2="23" y2="15"></line>}
          </svg>
        );

        const RotateIcon = () => (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M1 4v6h6"></path>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
          </svg>
        );

        const DiceGame = () => {
          // Game state
          const [screen, setScreen] = useState('welcome');
          const [gameSettings, setGameSettings] = useState({
            playerCount: 2,
            gameType: 1
          });
          const [players, setPlayers] = useState([]);
          const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
          const [gameRound, setGameRound] = useState(1);
          const [isRolling, setIsRolling] = useState(false);
          const [diceResults, setDiceResults] = useState([]);
          const [soundEnabled, setSoundEnabled] = useState(true);
          const [isFirstPlayer, setIsFirstPlayer] = useState(true);
          const [turnTimer, setTurnTimer] = useState(10);
          const audioRef = useRef(null);

          // Timer effect
          useEffect(() => {
            let interval = null;
            if (screen === 'game' && turnTimer > 0 && !isRolling) {
              interval = setInterval(() => {
                setTurnTimer(timer => {
                  if (timer <= 1) {
                    rollDice();
                    return 10;
                  }
                  return timer - 1;
                });
              }, 1000);
            }
            return () => clearInterval(interval);
          }, [screen, turnTimer, isRolling]);

          // Sound effects
          const playDiceSound = () => {
            if (soundEnabled && audioRef.current) {
              audioRef.current.currentTime = 0;
              audioRef.current.play().catch(e => console.log('Sound play failed:', e));
            }
          };

          // Enhanced dice rolling animation
          const rollDice = () => {
            if (isRolling) return;
            
            setIsRolling(true);
            setTurnTimer(10);
            playDiceSound();
            
            let rollCount = 0;
            const maxRolls = 20;
            
            const rollInterval = setInterval(() => {
              rollCount++;
              setDiceResults(Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1));
              
              if (rollCount >= maxRolls) {
                clearInterval(rollInterval);
                
                setTimeout(() => {
                  const finalResults = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1);
                  setDiceResults(finalResults);
                  
                  const score = calculateScore(finalResults);
                  const newPlayers = [...players];
                  if (newPlayers[currentPlayerIndex]) {
                    newPlayers[currentPlayerIndex].totalScore += score;
                    newPlayers[currentPlayerIndex].lastRoll = {
                      dice: finalResults,
                      score: score,
                      combination: getScoreCombination(finalResults)
                    };
                    setPlayers(newPlayers);
                  }
                  
                  setIsRolling(false);
                  
                  setTimeout(() => {
                    nextTurn();
                  }, 1500);
                }, 300);
              }
            }, 100);
          };

          // Calculate score
          const calculateScore = (dice) => {
            const counts = {};
            dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
            const values = Object.values(counts).sort((a,b) => b-a);
            const sortedDice = [...dice].sort((a,b) => a-b);
            
            if (values[0] === 5) {
              return 5000 * dice[0];
            }
            
            if (sortedDice.join('') === '12345' || sortedDice.join('') === '23456') {
              return 10000;
            }
            
            if (values[0] === 4) {
              const num = Object.keys(counts).find(k => counts[k] === 4);
              return 1500 * parseInt(num);
            }
            
            if (values[0] === 3 && values[1] === 2) {
              const threeNum = Object.keys(counts).find(k => counts[k] === 3);
              return 500 * parseInt(threeNum);
            }
            
            if (values[0] === 3) {
              const threeNum = Object.keys(counts).find(k => counts[k] === 3);
              return 250 * parseInt(threeNum);
            }
            
            if (values[0] === 2 && values[1] === 2) {
              const pairs = Object.keys(counts).filter(k => counts[k] === 2).map(Number);
              return 100 * Math.max(...pairs);
            }
            
            if (values[0] === 2) {
              const pairNum = Object.keys(counts).find(k => counts[k] === 2);
              return 10 * parseInt(pairNum);
            }
            
            return dice.reduce((sum, d) => sum + d, 0);
          };

          // Get combination name
          const getScoreCombination = (dice) => {
            const counts = {};
            dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
            const values = Object.values(counts).sort((a,b) => b-a);
            const sortedDice = [...dice].sort((a,b) => a-b);
            
            if (values[0] === 5) return '5 זהות!';
            if (sortedDice.join('') === '12345' || sortedDice.join('') === '23456') return 'רצף!';
            if (values[0] === 4) return '4 זהות';
            if (values[0] === 3 && values[1] === 2) return 'פול האוס';
            if (values[0] === 3) return '3 זהות';
            if (values[0] === 2 && values[1] === 2) return 'זוג כפול';
            if (values[0] === 2) return 'זוג';
            return 'ללא קומבינציה';
          };

          // Next turn logic
          const nextTurn = () => {
            const activePlayers = players.filter(p => !p.eliminated);
            let nextIndex = currentPlayerIndex;
            
            do {
              nextIndex = (nextIndex + 1) % players.length;
            } while (players[nextIndex] && players[nextIndex].eliminated);
            
            const firstActiveIndex = players.findIndex(p => !p.eliminated);
            if (nextIndex === firstActiveIndex && activePlayers.every(p => p.lastRoll)) {
              
              if (gameSettings.gameType === 1) {
                if (activePlayers.length > 1) {
                  const lowestScore = Math.min(...activePlayers.map(p => p.totalScore));
                  const newPlayers = players.map(p => ({
                    ...p,
                    eliminated: p.eliminated || (p.totalScore === lowestScore && !p.eliminated)
                  }));
                  setPlayers(newPlayers);
                  
                  const remaining = newPlayers.filter(p => !p.eliminated);
                  if (remaining.length === 1) {
                    setScreen('gameOver');
                    return;
                  }
                  
                  newPlayers.forEach(p => p.lastRoll = null);
                  setGameRound(gameRound + 1);
                  nextIndex = newPlayers.findIndex(p => !p.eliminated);
                }
              } else if (gameSettings.gameType === 2) {
                if (gameRound >= 5) {
                  setScreen('gameOver');
                  return;
                } else {
                  activePlayers.forEach(p => p.lastRoll = null);
                  setGameRound(gameRound + 1);
                  nextIndex = players.findIndex(p => !p.eliminated);
                }
              }
            }
            
            setCurrentPlayerIndex(nextIndex);
            setTurnTimer(10);
          };

          // Add player
          const addPlayer = (name) => {
            if (players.length < gameSettings.playerCount) {
              setPlayers([...players, {
                id: players.length + 1,
                name: name || `שחקן ${players.length + 1}`,
                totalScore: 0,
                eliminated: false,
                lastRoll: null
              }]);
              
              if (players.length + 1 === gameSettings.playerCount) {
                setScreen('game');
                setTurnTimer(10);
              }
            }
          };

          // Player position
          const getPlayerPosition = (index, total) => {
            const angle = (index * 360) / Math.min(total, 10);
            const radius = 45;
            const x = 50 + radius * Math.cos((angle - 90) * Math.PI / 180);
            const y = 50 + radius * Math.sin((angle - 90) * Math.PI / 180);
            return { x: `${x}%`, y: `${y}%` };
          };

          // Avatars and colors
          const avatarEmojis = [
            '🧑‍💼', '👩‍🦰', '🧑‍🎨', '👨‍🏫', '👩‍⚕️', 
            '🧑‍🚀', '👩‍🎤', '👨‍🍳', '👩‍🔬', '🧑‍🎮'
          ];

          const avatarGradients = [
            'bg-gradient-to-br from-red-400 to-red-600',
            'bg-gradient-to-br from-blue-400 to-blue-600', 
            'bg-gradient-to-br from-green-400 to-green-600',
            'bg-gradient-to-br from-yellow-400 to-orange-500',
            'bg-gradient-to-br from-purple-400 to-purple-600',
            'bg-gradient-to-br from-pink-400 to-pink-600',
            'bg-gradient-to-br from-indigo-400 to-indigo-600',
            'bg-gradient-to-br from-orange-400 to-red-500',
            'bg-gradient-to-br from-teal-400 to-teal-600',
            'bg-gradient-to-br from-gray-400 to-gray-600'
          ];

          return (
            <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4" dir="rtl">
              <audio 
                ref={audioRef} 
                preload="auto"
                src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEUATR2y/LPfOcFKnHM8dmINgkRbL3tqW8aBDNEn9/us2QZNB9B"
              />

              {/* Welcome Screen */}
              {screen === 'welcome' && (
                <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                  <h1 className="text-4xl font-bold text-green-800 mb-6">🎲</h1>
                  <h2 className="text-3xl font-bold text-gray-800 mb-8">משחק הקוביות של נועם</h2>
                  <button 
                    onClick={() => setScreen('setup')}
                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl w-full transition-colors"
                  >
                    התחל משחק
                  </button>
                  <button 
                    onClick={() => alert('הוראות המשחק:\n• כל שחקן בתורו זורק 5 קוביות\n• 10 שניות לכל תור\n• משחק 1: השחקן עם הניקוד הנמוך נפסל\n• משחק 2: 5 סיבובים, מנצח עם הניקוד הגבוה')}
                    className="mt-4 text-green-600 hover:text-green-700 underline"
                  >
                    הוראות משחק
                  </button>
                </div>
              )}

              {/* Setup Screen */}
              {screen === 'setup' && (
                <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                  <h2 className="text-2xl font-bold text-gray-800 mb-6">הגדרת משחק</h2>
                  
                  {isFirstPlayer && (
                    <>
                      <div className="mb-6">
                        <label className="block text-gray-700 font-bold mb-2">כמות שחקנים</label>
                        <select 
                          value={gameSettings.playerCount}
                          onChange={(e) => setGameSettings({...gameSettings, playerCount: parseInt(e.target.value)})}
                          className="w-full p-3 border rounded-lg text-center"
                        >
                          {[2,3,4,5,6,7,8,9].map(n => (
                            <option key={n} value={n}>{n} שחקנים</option>
                          ))}
                        </select>
                      </div>
                      
                      <div className="mb-6">
                        <label className="block text-gray-700 font-bold mb-2">סוג משחק</label>
                        <select 
                          value={gameSettings.gameType}
                          onChange={(e) => setGameSettings({...gameSettings, gameType: parseInt(e.target.value)})}
                          className="w-full p-3 border rounded-lg text-center"
                        >
                          <option value={1}>שחקן מול שחקן (קוביות שחקנים)</option>
                          <option value={2}>5 סיבובים (ללא הדחה)</option>
                          <option value={3} disabled>הימורים (לא פעיל)</option>
                        </select>
                      </div>
                    </>
                  )}
                  
                  <div className="mb-6">
                    <label className="block text-gray-700 font-bold mb-2">שם השחקן</label>
                    <input 
                      type="text"
                      placeholder="הכנס את שמך"
                      className="w-full p-3 border rounded-lg text-center"
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && e.target.value.trim()) {
                          addPlayer(e.target.value.trim());
                          e.target.value = '';
                          if (players.length + 1 < gameSettings.playerCount) {
                            setIsFirstPlayer(false);
                          }
                        }
                      }}
                    />
                  </div>
                  
                  <button 
                    onClick={(e) => {
                      const input = e.target.parentElement.querySelector('input');
                      if (input.value.trim()) {
                        addPlayer(input.value.trim());
                        input.value = '';
                        if (players.length + 1 < gameSettings.playerCount) {
                          setIsFirstPlayer(false);
                        }
                      }
                    }}
                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg w-full mb-4 transition-colors"
                  >
                    {players.length === 0 ? 'יצירת שולחן' : 'הצטרפות לשולחן'}
                  </button>
                  
                  {players.length > 0 && (
                    <div className="text-gray-600">
                      שחקנים: {players.length}/{gameSettings.playerCount}
                      <div className="mt-2">
                        {players.map(p => <div key={p.id} className="text-sm">{p.name}</div>)}
                      </div>
                      {players.length < gameSettings.playerCount && (
                        <div className="text-sm text-blue-600 mt-2">
                          ממתין לעוד {gameSettings.playerCount - players.length} שחקנים...
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* Game Screen */}
              {screen === 'game' && (
                <div className="w-full max-w-6xl mx-auto">
                  <div className="absolute top-4 left-4 z-10">
                    <button
                      onClick={() => setSoundEnabled(!soundEnabled)}
                      className="bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition-shadow"
                    >
                      <VolumeIcon enabled={soundEnabled} />
                    </button>
                  </div>

                  <div className="text-center text-white mb-6 relative">
                    <h2 className="text-2xl font-bold">
                      סיבוב {gameRound}
                      {gameSettings.gameType === 2 && <span className="text-yellow-300"> / 5</span>}
                    </h2>
                    <p>תור: {players[currentPlayerIndex]?.name}</p>
                    {!isRolling && (
                      <div className={`absolute left-8 top-1/2 transform -translate-y-1/2 text-lg font-bold ${turnTimer <= 3 ? 'text-red-400 animate-pulse' : 'text-yellow-300'}`}>
                        ⏰ {turnTimer} שניות
                      </div>
                    )}
                  </div>

                  <div className="relative w-full h-96 bg-green-600 rounded-full border-8 border-yellow-600 shadow-2xl mx-auto max-w-4xl">
                    {players.map((player, index) => {
                      const pos = getPlayerPosition(index, players.length);
                      const isCurrentPlayer = index === currentPlayerIndex;
                      return (
                        <div
                          key={player.id}
                          className={`absolute transform -translate-x-1/2 -translate-y-1/2 text-center ${
                            player.eliminated ? 'opacity-30 grayscale' : ''
                          } ${isCurrentPlayer ? 'scale-110 z-10' : ''} transition-all duration-500`}
                          style={{ left: pos.x, top: pos.y }}
                        >
                          <div className={`w-24 h-24 ${avatarGradients[index]} rounded-full flex items-center justify-center text-4xl mb-2 shadow-lg border-4 border-white ${
                            isCurrentPlayer ? 'ring-8 ring-yellow-400 ring-opacity-80 player-glow transform scale-110' : 'ring-2 ring-white ring-opacity-50'
                          } transition-all duration-500 hover:scale-105`}>
                            {avatarEmojis[index]}
                          </div>
                          <div className={`text-white text-base font-bold ${isCurrentPlayer ? 'text-yellow-300' : ''}`}>
                            {player.name}
                          </div>
                          <div className="text-yellow-300 text-base font-bold">{player.totalScore} נק'</div>
                          {player.lastRoll && (
                            <>
                              <div className="flex gap-1 justify-center mb-2 -mt-12">
                                {player.lastRoll.dice.map((dice, diceIndex) => (
                                  <div
                                    key={diceIndex}
                                    className="w-8 h-8 bg-white rounded-md text-black text-base flex items-center justify-center font-bold border-2 border-gray-400 shadow-lg transform hover:scale-110 transition-transform duration-200"
                                  >
                                    {dice}
                                  </div>
                                ))}
                              </div>
                              <div className="text-sm text-gray-200 mt-1">
                                {player.lastRoll.combination}<br/>
                                +{player.lastRoll.score}
                              </div>
                            </>
                          )}
                        </div>
                      );
                    })}

                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                      {diceResults.length > 0 && (
                        <div className="flex gap-3 mb-6 justify-center">
                          {diceResults.map((dice, index) => (
                            <div
                              key={index}
                              className={`w-16 h-16 bg-white rounded-xl flex items-center justify-center text-3xl font-bold border-3 border-gray-400 shadow-2xl transform transition-all duration-300 ${
                                isRolling ? 'dice-roll scale-110' : 'hover:scale-105'
                              }`}
                              style={{
                                animationDelay: isRolling ? `${index * 0.1}s` : '0s',
                                background: isRolling ? 'linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57)' : 'white',
                                backgroundSize: isRolling ? '300% 300%' : 'auto',
                                animation: isRolling ? 'gradient 0.5s ease infinite, spin 0.3s linear infinite' : 'none'
                              }}
                            >
                              <span className={isRolling ? 'animate-bounce' : ''}>{dice}</span>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {!isRolling && (
                        <button
                          onClick={rollDice}
                          className="bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl"
                        >
                          <span className="text-2xl mr-2">🎲</span>
                          זרוק קוביות
                        </button>
                      )}
                      
                      {isRolling && (
                        <div className="text-white font-bold text-xl animate-pulse bg-black bg-opacity-50 rounded-lg px-6 py-3">
                          <span className="animate-bounce inline-block">🎲</span>
                          <span className="mx-2">זורק קוביות...</span>
                          <span className="animate-bounce inline-block" style={{animationDelay: '0.2s'}}>🎲</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {players[currentPlayerIndex]?.lastRoll && (
                    <div className="text-center text-white mt-6 bg-black bg-opacity-50 rounded-lg p-4 max-w-md mx-auto">
                      <h3 className="text-xl font-bold">{players[currentPlayerIndex].lastRoll.combination}</h3>
                      <p className="text-lg">+{players[currentPlayerIndex].lastRoll.score} נקודות</p>
                      <p className="text-sm opacity-75">סה"כ: {players[currentPlayerIndex].totalScore} נקודות</p>
                    </div>
                  )}
                </div>
              )}

              {/* Game Over Screen */}
              {screen === 'gameOver' && (
                <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                  <h1 className="text-6xl mb-4">🏆</h1>
                  <h2 className="text-3xl font-bold text-yellow-600 mb-4">
                    {gameSettings.gameType === 1 
                      ? players.find(p => !p.eliminated)?.name 
                      : (() => {
                          const activePlayers = players.filter(p => !p.eliminated);
                          const highestScore = Math.max(...activePlayers.map(p => p.totalScore));
                          const winners = activePlayers.filter(p => p.totalScore === highestScore);
                          return winners.length === 1 ? winners[0].name : `${winners.length} מנצחים!`;
                        })()
                    }
                  </h2>
                  <p className="text-xl text-gray-700 mb-2">מנצח!</p>
                  <p className="text-lg text-gray-600 mb-6">
                    ניקוד סופי: {gameSettings.gameType === 1 
                      ? players.find(p => !p.eliminated)?.totalScore 
                      : Math.max(...players.filter(p => !p.eliminated).map(p => p.totalScore))
                    } נקודות
                  </p>
                  <button
                    onClick={() => {
                      setScreen('welcome');
                      setPlayers([]);
                      setCurrentPlayerIndex(0);
                      setGameRound(1);
                      setDiceResults([]);
                      setIsFirstPlayer(true);
                      setTurnTimer(10);
                    }}
                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg w-full transition-colors flex items-center justify-center gap-2"
                  >
                    <RotateIcon />
                    משחק חדש
                  </button>
                </div>
              )}
            </div>
          );
        };

        ReactDOM.render(React.createElement(DiceGame), document.getElementById('root'));
    </script>
</body>
</html>
