<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק הקוביות של נועם</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 255, 0, 0.8); }
        }
        .player-glow {
            animation: glow 1s ease-in-out infinite;
        }
        @keyframes diceRoll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(90deg) rotateY(90deg); }
            50% { transform: rotateX(180deg) rotateY(180deg); }
            75% { transform: rotateX(270deg) rotateY(270deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        .dice-roll {
            animation: diceRoll 0.1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase Configuration - הנתונים שלכם
        const firebaseConfig = {
            apiKey: "AIzaSyAgWTlNnhRHQ_iGt10EgFuxkib-Z-ifa7s",
            authDomain: "noam-s-dice-game.firebaseapp.com",
            databaseURL: "https://noam-s-dice-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "noam-s-dice-game",
            storageBucket: "noam-s-dice-game.firebasestorage.app",
            messagingSenderId: "504625659348",
            appId: "1:504625659348:web:718a1b6b6317bf45cdea41"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        const { useState, useEffect, useRef } = React;

        const DiceGame = () => {
            const [screen, setScreen] = useState('welcome');
            const [playerName, setPlayerName] = useState('');
            const [gameId, setGameId] = useState('');
            const [playerId, setPlayerId] = useState('');
            const [gameSettings, setGameSettings] = useState({ playerCount: 2, gameType: 1 });
            const [players, setPlayers] = useState([]);
            const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
            const [gameRound, setGameRound] = useState(1);
            const [isRolling, setIsRolling] = useState(false);
            const [diceResults, setDiceResults] = useState([]);
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [turnTimer, setTurnTimer] = useState(10);
            const [gameData, setGameData] = useState(null);
            
            const gameRef = useRef(null);

            const generateId = () => Math.random().toString(36).substr(2, 9);

            const calculateScore = (dice) => {
                const counts = {};
                dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
                const values = Object.values(counts).sort((a,b) => b-a);
                const sortedDice = [...dice].sort((a,b) => a-b);
                
                if (values[0] === 5) return 5000 * dice[0];
                if (sortedDice.join('') === '12345' || sortedDice.join('') === '23456') return 10000;
                if (values[0] === 4) {
                    const num = Object.keys(counts).find(k => counts[k] === 4);
                    return 1500 * parseInt(num);
                }
                if (values[0] === 3 && values[1] === 2) {
                    const threeNum = Object.keys(counts).find(k => counts[k] === 3);
                    return 500 * parseInt(threeNum);
                }
                if (values[0] === 3) {
                    const threeNum = Object.keys(counts).find(k => counts[k] === 3);
                    return 250 * parseInt(threeNum);
                }
                if (values[0] === 2 && values[1] === 2) {
                    const pairs = Object.keys(counts).filter(k => counts[k] === 2).map(Number);
                    return 100 * Math.max(...pairs);
                }
                if (values[0] === 2) {
                    const pairNum = Object.keys(counts).find(k => counts[k] === 2);
                    return 10 * parseInt(pairNum);
                }
                return dice.reduce((sum, d) => sum + d, 0);
            };

            const getScoreCombination = (dice) => {
                const counts = {};
                dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
                const values = Object.values(counts).sort((a,b) => b-a);
                const sortedDice = [...dice].sort((a,b) => a-b);
                
                if (values[0] === 5) return '5 זהות!';
                if (sortedDice.join('') === '12345' || sortedDice.join('') === '23456') return 'רצף!';
                if (values[0] === 4) return '4 זהות';
                if (values[0] === 3 && values[1] === 2) return 'פול האוס';
                if (values[0] === 3) return '3 זהות';
                if (values[0] === 2 && values[1] === 2) return 'זוג כפול';
                if (values[0] === 2) return 'זוג';
                return 'ללא קומבינציה';
            };

            const rollDice = async () => {
                if (isRolling || !gameData || gameData.currentPlayerId !== playerId) return;
                
                setIsRolling(true);
                setTurnTimer(10);
                
                let rollCount = 0;
                const maxRolls = 20;
                
                const rollInterval = setInterval(() => {
                    rollCount++;
                    setDiceResults(Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1));
                    
                    if (rollCount >= maxRolls) {
                        clearInterval(rollInterval);
                        
                        setTimeout(async () => {
                            const finalResults = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1);
                            setDiceResults(finalResults);
                            
                            const score = calculateScore(finalResults);
                            const combination = getScoreCombination(finalResults);
                            
                            try {
                                const updates = {};
                                const currentScore = gameData.players[playerId].totalScore || 0;
                                updates[`players/${playerId}/totalScore`] = currentScore + score;
                                updates[`players/${playerId}/lastRoll`] = {
                                    dice: finalResults,
                                    score: score,
                                    combination: combination,
                                    timestamp: Date.now()
                                };
                                
                                await database.ref(`games/${gameId}`).update(updates);
                                
                                setTimeout(() => {
                                    nextTurn();
                                }, 1500);
                                
                            } catch (error) {
                                console.error('שגיאה:', error);
                            }
                            
                            setIsRolling(false);
                        }, 300);
                    }
                }, 100);
            };

            const nextTurn = async () => {
                if (!gameData) return;
                
                const playersList = Object.values(gameData.players);
                const activePlayers = playersList.filter(p => !p.eliminated);
                const currentIndex = playersList.findIndex(p => p.id === gameData.currentPlayerId);
                
                let nextPlayerIndex = currentIndex;
                do {
                    nextPlayerIndex = (nextPlayerIndex + 1) % playersList.length;
                } while (playersList[nextPlayerIndex] && playersList[nextPlayerIndex].eliminated);
                
                const firstActiveIndex = playersList.findIndex(p => !p.eliminated);
                if (nextPlayerIndex === firstActiveIndex && activePlayers.every(p => p.lastRoll)) {
                    if (gameSettings.gameType === 1) {
                        if (activePlayers.length > 1) {
                            const lowestScore = Math.min(...activePlayers.map(p => p.totalScore));
                            const updates = {};
                            
                            activePlayers.forEach(player => {
                                if (player.totalScore === lowestScore) {
                                    updates[`players/${player.id}/eliminated`] = true;
                                }
                                updates[`players/${player.id}/lastRoll`] = null;
                            });
                            
                            const remaining = activePlayers.filter(p => p.totalScore !== lowestScore);
                            if (remaining.length === 1) {
                                updates['status'] = 'finished';
                                updates['winner'] = remaining[0].id;
                            } else {
                                updates['gameRound'] = (gameData.gameRound || 1) + 1;
                                updates['currentPlayerId'] = remaining[0].id;
                            }
                            
                            await database.ref(`games/${gameId}`).update(updates);
                        }
                    }
                } else {
                    await database.ref(`games/${gameId}/currentPlayerId`).set(playersList[nextPlayerIndex].id);
                }
                
                setTurnTimer(10);
            };

            const createGame = async () => {
                const newGameId = generateId();
                const newPlayerId = generateId();
                
                const gameData = {
                    id: newGameId,
                    status: 'waiting',
                    settings: gameSettings,
                    players: {
                        [newPlayerId]: {
                            id: newPlayerId,
                            name: playerName,
                            totalScore: 0,
                            eliminated: false,
                            lastRoll: null,
                            isHost: true,
                            joinedAt: Date.now()
                        }
                    },
                    currentPlayerId: newPlayerId,
                    gameRound: 1,
                    createdAt: Date.now()
                };

                try {
                    await database.ref(`games/${newGameId}`).set(gameData);
                    
                    setGameId(newGameId);
                    setPlayerId(newPlayerId);
                    gameRef.current = database.ref(`games/${newGameId}`);
                    setScreen('waiting');
                    alert(`שולחן נוצר! קוד: ${newGameId}`);
                } catch (error) {
                    console.error('שגיאה:', error);
                    alert('שגיאה: ' + error.message);
                }
            };

            const joinGame = async () => {
                const newPlayerId = generateId();
                
                try {
                    // Set up Firebase reference FIRST
                    setGameId(gameId);
                    setPlayerId(newPlayerId);
                    gameRef.current = database.ref(`games/${gameId}`);
                    
                    const gameSnapshot = await database.ref(`games/${gameId}`).once('value');
                    const existingGame = gameSnapshot.val();
                    
                    if (!existingGame) {
                        alert('שולחן לא נמצא!');
                        return;
                    }
                    
                    if (existingGame.status !== 'waiting') {
                        alert('המשחק כבר התחיל!');
                        return;
                    }
                    
                    const playerCount = Object.keys(existingGame.players || {}).length;
                    if (playerCount >= existingGame.settings.playerCount) {
                        alert('השולחן מלא!');
                        return;
                    }

                    await database.ref(`games/${gameId}/players/${newPlayerId}`).set({
                        id: newPlayerId,
                        name: playerName,
                        totalScore: 0,
                        eliminated: false,
                        lastRoll: null,
                        isHost: false,
                        joinedAt: Date.now()
                    });
                    
                    setScreen('waiting');
                    
                    setTimeout(async () => {
                        const updatedSnapshot = await database.ref(`games/${gameId}`).once('value');
                        const updatedGame = updatedSnapshot.val();
                        if (updatedGame) {
                            const currentPlayerCount = Object.keys(updatedGame.players || {}).length;
                            if (currentPlayerCount >= updatedGame.settings.playerCount && updatedGame.status === 'waiting') {
                                await database.ref(`games/${gameId}/status`).set('playing');
                            }
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('שגיאה:', error);
                    alert('שגיאה: ' + error.message);
                }
            };

            // Fixed Firebase listener
            useEffect(() => {
                if (gameId && gameRef.current) {
                    const unsubscribe = gameRef.current.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setGameData(data);
                            setPlayers(Object.values(data.players || {}));
                            setGameSettings(data.settings || { playerCount: 2, gameType: 1 });
                            setCurrentPlayerIndex(Object.values(data.players || {}).findIndex(p => p.id === data.currentPlayerId));
                            setGameRound(data.gameRound || 1);
                            
                            if (data.status === 'playing') {
                                setScreen('game');
                            } else if (data.status === 'finished') {
                                setScreen('gameOver');
                            } else if (data.status === 'waiting') {
                                setScreen('waiting');
                            }
                        }
                    });

                    return () => gameRef.current.off('value', unsubscribe);
                }
            }, [gameId]);

            useEffect(() => {
                let interval = null;
                if (screen === 'game' && turnTimer > 0 && !isRolling && gameData && gameData.currentPlayerId === playerId) {
                    interval = setInterval(() => {
                        setTurnTimer(timer => {
                            if (timer <= 1) {
                                rollDice();
                                return 10;
                            }
                            return timer - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [screen, turnTimer, isRolling, gameData, playerId]);

            const getPlayerPosition = (index, total) => {
                const angle = (index * 360) / Math.min(total, 10);
                const radius = 45;
                const x = 50 + radius * Math.cos((angle - 90) * Math.PI / 180);
                const y = 50 + radius * Math.sin((angle - 90) * Math.PI / 180);
                return { x: `${x}%`, y: `${y}%` };
            };

            const avatarEmojis = ['🧑‍💼', '👩‍🦰', '🧑‍🎨', '👨‍🏫', '👩‍⚕️', '🧑‍🚀', '👩‍🎤', '👨‍🍳', '👩‍🔬', '🧑‍🎮'];
            const avatarGradients = [
                'bg-gradient-to-br from-red-400 to-red-600',
                'bg-gradient-to-br from-blue-400 to-blue-600', 
                'bg-gradient-to-br from-green-400 to-green-600',
                'bg-gradient-to-br from-yellow-400 to-orange-500',
                'bg-gradient-to-br from-purple-400 to-purple-600'
            ];

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4" dir="rtl">

                    {screen === 'welcome' && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h1 className="text-4xl font-bold text-green-800 mb-6">🎲</h1>
                            <h2 className="text-3xl font-bold text-gray-800 mb-8">משחק הקוביות של נועם</h2>
                            
                            <div className="space-y-4">
                                <input 
                                    type="text"
                                    placeholder="הכנס את שמך"
                                    value={playerName}
                                    onChange={(e) => setPlayerName(e.target.value)}
                                    className="w-full p-3 border rounded-lg text-center text-lg"
                                />
                                
                                <button 
                                    onClick={() => setScreen('setup')}
                                    disabled={!playerName.trim()}
                                    className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg text-xl w-full"
                                >
                                    צור שולחן חדש
                                </button>
                                
                                <div className="text-gray-500 font-bold">או</div>
                                
                                <input 
                                    type="text"
                                    placeholder="קוד שולחן"
                                    value={gameId}
                                    onChange={(e) => setGameId(e.target.value.toLowerCase())}
                                    className="w-full p-3 border rounded-lg text-center text-lg"
                                    maxLength={9}
                                />
                                
                                <button 
                                    onClick={joinGame}
                                    disabled={!playerName.trim() || gameId.trim().length < 5}
                                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg text-lg w-full"
                                >
                                    הצטרף לשולחן
                                </button>
                            </div>
                        </div>
                    )}

                    {screen === 'setup' && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">הגדרת שולחן</h2>
                            <p className="text-lg text-gray-600 mb-6">שלום {playerName}!</p>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-gray-700 font-bold mb-2">כמות שחקנים</label>
                                    <select 
                                        value={gameSettings.playerCount}
                                        onChange={(e) => setGameSettings({...gameSettings, playerCount: parseInt(e.target.value)})}
                                        className="w-full p-3 border rounded-lg text-center text-lg"
                                    >
                                        {[2,3,4,5].map(n => (
                                            <option key={n} value={n}>{n} שחקנים</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <button onClick={createGame} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg w-full">
                                    צור שולחן
                                </button>
                                
                                <button onClick={() => setScreen('welcome')} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg w-full">
                                    חזור
                                </button>
                            </div>
                        </div>
                    )}

                    {screen === 'waiting' && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">ממתין לשחקנים</h2>
                            
                            <div className="bg-gray-100 p-4 rounded-lg mb-4">
                                <p className="text-sm text-gray-600 mb-2">קוד השולחן:</p>
                                <p className="text-2xl font-mono font-bold text-green-600">{gameId}</p>
                            </div>
                            
                            <div className="mb-6">
                                <p className="text-lg font-bold mb-2">
                                    שחקנים: {gameData ? Object.keys(gameData.players || {}).length : 0}/{gameSettings.playerCount}
                                </p>
                                <div className="space-y-2">
                                    {(gameData ? Object.values(gameData.players || {}) : []).map((player) => (
                                        <div key={player.id} className="flex items-center justify-center gap-2">
                                            <span className="text-2xl">🎮</span>
                                            <span className="font-medium">{player.name}</span>
                                            {player.isHost && <span className="text-xs bg-yellow-200 px-2 py-1 rounded">מארח</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="text-sm text-gray-600">
                                {(gameData ? Object.keys(gameData.players || {}).length : 0) < gameSettings.playerCount ? (
                                    <>ממתין לעוד {gameSettings.playerCount - (gameData ? Object.keys(gameData.players || {}).length : 0)} שחקנים...</>
                                ) : (
                                    <span className="text-green-600 font-bold">מתחיל משחק...</span>
                                )}
                            </div>
                        </div>
                    )}

                    {screen === 'game' && gameData && (
                        <div className="w-full max-w-6xl mx-auto">
                            <div className="text-center text-white mb-6">
                                <h2 className="text-2xl font-bold">סיבוב {gameRound}</h2>
                                <p>תור: {gameData.players[gameData.currentPlayerId]?.name}</p>
                                {!isRolling && gameData.currentPlayerId === playerId && (
                                    <div className="text-yellow-300 font-bold">⏰ {turnTimer} שניות</div>
                                )}
                            </div>

                            <div className="relative w-full h-96 bg-green-600 rounded-full border-8 border-yellow-600 shadow-2xl mx-auto max-w-4xl">
                                {players.map((player, index) => {
                                    const pos = getPlayerPosition(index, players.length);
                                    const isCurrentPlayer = gameData.currentPlayerId === player.id;
                                    return (
                                        <div
                                            key={player.id}
                                            className={`absolute transform -translate-x-1/2 -translate-y-1/2 text-center ${
                                                player.eliminated ? 'opacity-30' : ''
                                            } ${isCurrentPlayer ? 'scale-110' : ''}`}
                                            style={{ left: pos.x, top: pos.y }}
                                        >
                                            <div className={`w-20 h-20 ${avatarGradients[index]} rounded-full flex items-center justify-center text-3xl mb-2 shadow-lg border-4 border-white ${
                                                isCurrentPlayer ? 'player-glow' : ''
                                            }`}>
                                                {avatarEmojis[index]}
                                            </div>
                                            <div className="text-white text-sm font-bold bg-black bg-opacity-50 rounded px-2 py-1 mb-1">
                                                {player.name}
                                            </div>
                                            <div className="text-yellow-300 text-sm font-bold bg-black bg-opacity-50 rounded px-2 py-1">{player.totalScore} נק'</div>
                                            {player.lastRoll && (
                                                <>
                                                    <div className="flex gap-1 justify-center mt-2">
                                                        {player.lastRoll.dice.map((dice, diceIndex) => (
                                                            <div
                                                                key={diceIndex}
                                                                className="w-6 h-6 bg-white rounded text-black text-xs flex items-center justify-center font-bold"
                                                            >
                                                                {dice}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="text-xs text-gray-200 bg-black bg-opacity-50 rounded px-1 py-0.5 mt-1">
                                                        {player.lastRoll.combination}<br/>+{player.lastRoll.score}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    );
                                })}

                                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                                    {diceResults.length > 0 && (
                                        <div className="flex gap-3 mb-6 justify-center">
                                            {diceResults.map((dice, index) => (
                                                <div
                                                    key={index}
                                                    className={`w-16 h-16 bg-white rounded-xl flex items-center justify-center text-3xl font-bold shadow-2xl ${
                                                        isRolling ? 'dice-roll' : ''
                                                    }`}
                                                >
                                                    {dice}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {!isRolling && gameData.currentPlayerId === playerId && (
                                        <button
                                            onClick={rollDice}
                                            className="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg"
                                        >
                                            <span className="text-2xl mr-2">🎲</span>
                                            זרוק קוביות
                                        </button>
                                    )}
                                    
                                    {isRolling && (
                                        <div className="text-white font-bold text-xl bg-black bg-opacity-50 rounded-lg px-6 py-3">
                                            זורק קוביות...
                                        </div>
                                    )}

                                    {!isRolling && gameData.currentPlayerId !== playerId && (
                                        <div className="text-white font-bold text-lg bg-black bg-opacity-50 rounded-lg px-6 py-3">
                                            ממתין ל{gameData.players[gameData.currentPlayerId]?.name}...
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'gameOver' && gameData && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h1 className="text-6xl mb-4">🏆</h1>
                            <h2 className="text-3xl font-bold text-yellow-600 mb-4">
                                {gameData.winner ? gameData.players[gameData.winner]?.name : 'משחק הסתיים'}
                            </h2>
                            <p className="text-xl text-gray-700 mb-2">מנצח!</p>
                            
                            <button
                                onClick={() => {
                                    if (gameRef.current) {
                                        gameRef.current.remove();
                                    }
                                    setScreen('welcome');
                                    setGameId('');
                                    setPlayerId('');
                                    setPlayers([]);
                                    setGameData(null);
                                }}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg w-full"
                            >
                                🔄 משחק חדש
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(React.createElement(DiceGame), document.getElementById('root'));
    </script>
</body>
</html>
