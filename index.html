<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² ××©×—×§ ×”×§×•×‘×™×•×ª ×©×œ × ×•×¢× - ××§×•×•×Ÿ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ×”×©×ª×§×ª ××–×”×¨×ª Tailwind
        if (window.tailwind) {
            window.tailwind.config = {
                corePlugins: { preflight: false }
            };
        }
        
        // ×”×¡×ª×¨×ª ××–×”×¨×•×ª ×¤×™×ª×•×— (××•×¤×¦×™×•× ×œ×™)
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('should not be used in production') || 
                message.includes('Be sure to precompile')) {
                return; // ×“×œ×’ ×¢×œ ×”××–×”×¨×•×ª ×”××œ×”
            }
            originalWarn.apply(console, args);
        };
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        .dice-roll { animation: spin 0.1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .player-glow { box-shadow: 0 0 20px gold; animation: glow 1s ease-in-out infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px gold; } 50% { box-shadow: 0 0 40px gold; } }
        .online-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // âš ï¸ ×”×—×œ×£ ××ª ×”×”×’×“×¨×•×ª ×”××œ×” ×¢× ×”×”×’×“×¨×•×ª ×©×œ×š ×Firebase!
const firebaseConfig = {
  apiKey: "AIzaSyAgWTlNnhRHQ_iGt10EgFuxkib-Z-ifa7s",
  authDomain: "noam-s-dice-game.firebaseapp.com",
  databaseURL: "https://noam-s-dice-game-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "noam-s-dice-game",
  storageBucket: "noam-s-dice-game.firebasestorage.app",
  messagingSenderId: "504625659348",
  appId: "1:504625659348:web:718a1b6b6317bf45cdea41",
  measurementId: "G-H0P3KWLM1P"
};

        // Initialize Firebase
        let database = null;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
        } catch (error) {
            console.log('Firebase not configured:', error);
        }

        const { useState, useEffect, useRef } = React;

        function DiceGame() {
            // Game state
            const [screen, setScreen] = useState('welcome');
            const [gameMode, setGameMode] = useState('local');
            const [gameRoomId, setGameRoomId] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [playerId, setPlayerId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [isGameOwner, setIsGameOwner] = useState(false);
            const [connectedPlayers, setConnectedPlayers] = useState([]);
            
            // Local game state
            const [players, setPlayers] = useState([]);
            const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
            const [gameRound, setGameRound] = useState(1);
            const [isRolling, setIsRolling] = useState(false);
            const [diceResults, setDiceResults] = useState([]);
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [gameSettings, setGameSettings] = useState({ playerCount: 2, gameType: 1 });
            const [isFirstPlayer, setIsFirstPlayer] = useState(true);
            // State × ×•×¡×£ ×œ×× ×™×¢×ª ×”×‘×”×•×‘×™×
            const [showRules, setShowRules] = useState(false);
            const [isTransitioning, setIsTransitioning] = useState(false);

            const avatarEmojis = ['ğŸ§‘â€ğŸ’¼', 'ğŸ‘©â€ğŸ¦°', 'ğŸ§‘â€ğŸ¨', 'ğŸ‘¨â€ğŸ«', 'ğŸ‘©â€âš•ï¸', 'ğŸ§‘â€ğŸš€', 'ğŸ‘©â€ğŸ¤', 'ğŸ‘¨â€ğŸ³', 'ğŸ‘©â€ğŸ”¬'];
            const avatarGradients = [
                'bg-gradient-to-br from-red-400 to-red-600',
                'bg-gradient-to-br from-blue-400 to-blue-600', 
                'bg-gradient-to-br from-green-400 to-green-600',
                'bg-gradient-to-br from-yellow-400 to-orange-500',
                'bg-gradient-to-br from-purple-400 to-purple-600',
                'bg-gradient-to-br from-pink-400 to-pink-600',
                'bg-gradient-to-br from-indigo-400 to-indigo-600',
                'bg-gradient-to-br from-orange-400 to-red-500',
                'bg-gradient-to-br from-teal-400 to-teal-600'
            ];

            // Generate unique player ID
            useEffect(() => {
                if (!playerId) {
                    setPlayerId('player_' + Math.random().toString(36).substr(2, 9));
                }
            }, []);

            // ×¤×•× ×§×¦×™×•×ª ×‘×“×™×§×ª ×¡×•×’ ××©×—×§
            const isEliminationGame = () => {
                return gameMode === 'online' 
                    ? gameData?.settings?.gameType === 1 
                    : gameSettings.gameType === 1;
            };

            const isFiveRoundGame = () => {
                return gameMode === 'online' 
                    ? gameData?.settings?.gameType === 2 
                    : gameSettings.gameType === 2;
            };

            // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×ª×¦×•×’×ª ×¡×•×’ ×”××©×—×§
            const getGameTypeDisplay = () => {
                const gameType = gameMode === 'online' 
                    ? gameData?.settings?.gameType 
                    : gameSettings.gameType;
                
                if (gameType === 2) {
                    const currentRound = gameMode === 'online' 
                        ? gameData?.gameRound || 1 
                        : gameRound;
                    return `ğŸ¯ ×¡×™×‘×•×‘ ${currentRound}/5`;
                }
                
                const currentRound = gameMode === 'online' 
                    ? gameData?.gameRound || 1 
                    : gameRound;
                return `ğŸ”¥ ×¡×™×‘×•×‘ ${currentRound}`;
            };

            // Listen to game changes when online
            useEffect(() => {
                if (gameMode === 'online' && gameRoomId && database) {
                    const gameRef = database.ref(`games/${gameRoomId}`);
                    
                    const handleGameUpdate = (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            console.log('=== Firebase Update ===');
                            console.log('Game status:', data.status);
                            console.log('Current player index:', data.currentPlayerIndex);
                            console.log('Is rolling:', data.isRolling);
                            
                            setGameData(data);
                            if (data.players) {
                                const activePlayers = Object.values(data.players).filter(p => !p.eliminated);
                                setConnectedPlayers(Object.values(data.players));
                                
                                console.log('Active players count:', activePlayers.length);
                                console.log('Active players:', activePlayers.map(p => p.name));
                                
                                // ×× ×’× ×•×Ÿ ××•×˜×•××˜×™ ×œ××¢×‘×¨ ×ª×•×¨×•×ª - ×¨×§ ×× ×”××©×—×§ ×¤×¢×™×œ
                                if (data.status === 'playing' && !data.isRolling) {
                                    const playersWithRolls = activePlayers.filter(p => p.lastRoll);
                                    
                                    console.log('=== Auto Turn Check ===');
                                    console.log('Players with rolls:', playersWithRolls.length, '/', activePlayers.length);
                                    console.log('Current player:', activePlayers[data.currentPlayerIndex]?.name);
                                    console.log('Current player rolled:', !!activePlayers[data.currentPlayerIndex]?.lastRoll);
                                    
                                    // ×× ×›×œ ×”×©×—×§× ×™× ×–×¨×§×• - ×¡×™×™× ×¡×™×‘×•×‘
                                    if (playersWithRolls.length === activePlayers.length && activePlayers.length > 1) {
                                        console.log('ğŸš¨ All players have rolled - ending round');
                                        setTimeout(async () => {
                                            const recentSnapshot = await gameRef.once('value');
                                            const recentData = recentSnapshot.val();
                                            if (recentData && recentData.status === 'playing') {
                                                await checkAndAdvanceTurnFixed();
                                            }
                                        }, 800);
                                    } 
                                    // ×× ×”×©×—×§×Ÿ ×”× ×•×›×—×™ ×›×‘×¨ ×–×¨×§ - ×¢×‘×•×¨ ×œ×©×—×§×Ÿ ×”×‘×
                                    else if (playersWithRolls.length < activePlayers.length) {
                                        const currentPlayer = activePlayers[data.currentPlayerIndex];
                                        if (currentPlayer && currentPlayer.lastRoll) {
                                            console.log('ğŸš¨ Current player already rolled - moving to next');
                                            
                                            // ×¡×™××•×Ÿ ××¢×‘×¨ ×ª×•×¨
                                            setIsTransitioning(true);
                                            
                                            setTimeout(async () => {
                                                const recentSnapshot = await gameRef.once('value');
                                                const recentData = recentSnapshot.val();
                                                if (recentData && recentData.status === 'playing') {
                                                    await checkAndAdvanceTurnFixed();
                                                }
                                                
                                                // ××™×¤×•×¡ ×”××¢×‘×¨
                                                setTimeout(() => {
                                                    setIsTransitioning(false);
                                                }, 500);
                                            }, 800);
                                        }
                                    }
                                }
                            }
                            
                            if (data.status === 'finished') {
                                console.log('ğŸ† Game finished detected, showing game over screen');
                                setScreen('gameOver');
                            }
                        }
                    };

                    gameRef.on('value', handleGameUpdate);
                    
                    return () => gameRef.off('value', handleGameUpdate);
                }
            }, [gameMode, gameRoomId]);

            // Helper Functions
            const getPlayerPosition = (index, total) => {
                const angle = (index * 360) / Math.min(total, 10);
                const radiusX = 45;
                const radiusY = 35;
                const x = 50 + radiusX * Math.cos((angle - 90) * Math.PI / 180);
                const y = 50 + radiusY * Math.sin((angle - 90) * Math.PI / 180);
                return { x: `${x}%`, y: `${y}%` };
            };

            const calculateScore = (dice) => {
                if (!dice || !Array.isArray(dice) || dice.length === 0) {
                    return 0;
                }
                
                const validDice = dice.filter(d => d >= 1 && d <= 6);
                if (validDice.length === 0) {
                    return 0;
                }
                
                const counts = {};
                validDice.forEach(d => counts[d] = (counts[d] || 0) + 1);
                const values = Object.values(counts).sort((a,b) => b-a);
                const sortedDice = [...validDice].sort((a,b) => a-b);
                
                if (values[0] === 5) {
                    const num = Object.keys(counts).find(k => counts[k] === 5);
                    return 5000 * parseInt(num);
                }
                if (sortedDice.join('') === '12345' || sortedDice.join('') === '23456') {
                    return 10000;
                }
                if (values[0] === 4) {
                    const num = Object.keys(counts).find(k => counts[k] === 4);
                    return 1500 * parseInt(num);
                }
                if (values[0] === 3 && values[1] === 2) {
                    const threeNum = Object.keys(counts).find(k => counts[k] === 3);
                    return 500 * parseInt(threeNum);
                }
                if (values[0] === 3) {
                    const threeNum = Object.keys(counts).find(k => counts[k] === 3);
                    return 250 * parseInt(threeNum);
                }
                if (values[0] === 2 && values[1] === 2) {
                    const pairs = Object.keys(counts).filter(k => counts[k] === 2).map(Number);
                    return 100 * Math.max(...pairs);
                }
                if (values[0] === 2) {
                    const pairNum = Object.keys(counts).find(k => counts[k] === 2);
                    return 10 * parseInt(pairNum);
                }
                return validDice.reduce((sum, d) => sum + d, 0);
            };

            const getScoreCombination = (dice) => {
                if (!dice || !Array.isArray(dice) || dice.length === 0) {
                    return 'ğŸ¯ ×œ×œ× ×§×•××‘×™× ×¦×™×”';
                }
                
                const validDice = dice.filter(d => d >= 1 && d <= 6);
                if (validDice.length === 0) {
                    return 'ğŸ¯ ×œ×œ× ×§×•××‘×™× ×¦×™×”';
                }
                
                const counts = {};
                validDice.forEach(d => counts[d] = (counts[d] || 0) + 1);
                const values = Object.values(counts).sort((a,b) => b-a);
                const sortedDice = [...validDice].sort((a,b) => a-b);
                
                if (values[0] === 5) return 'ğŸ¯ 5 ×–×”×•×ª!';
                if (sortedDice.join('') === '12345' || sortedDice.join('') === '23456') return 'ğŸ² ×¨×¦×£ ××œ×!';
                if (values[0] === 4) return 'ğŸ”¥ 4 ×–×”×•×ª';
                if (values[0] === 3 && values[1] === 2) return 'ğŸ  ×¤×•×œ ×”××•×¡';
                if (values[0] === 3) return 'âœ¨ 3 ×–×”×•×ª';
                if (values[0] === 2 && values[1] === 2) return 'ğŸ‘¥ ×–×•×’ ×›×¤×•×œ';
                if (values[0] === 2) return 'ğŸ‘« ×–×•×’';
                return 'ğŸ¯ ×œ×œ× ×§×•××‘×™× ×¦×™×”';
            };

            // Firebase Helper Functions
            const createGameRoom = async () => {
                if (!database) {
                    alert('Firebase ×œ× ××•×’×“×¨. ×× × ×”×’×“×¨ ××ª Firebase ×§×•×“×.');
                    return;
                }

                const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
                const gameRef = database.ref(`games/${roomId}`);
                
                const initialGameData = {
                    roomId: roomId,
                    owner: playerId,
                    status: 'waiting',
                    settings: {
                        playerCount: gameSettings.playerCount,
                        gameType: gameSettings.gameType // ×”×•×¡×¤×ª ×¡×•×’ ×”××©×—×§
                    },
                    players: {
                        [playerId]: {
                            id: playerId,
                            name: playerName,
                            totalScore: 0,
                            eliminated: false,
                            lastRoll: null,
                            isOnline: true,
                            joinedAt: Date.now()
                        }
                    },
                    currentPlayerIndex: 0,
                    gameRound: 1,
                    currentDice: [],
                    isRolling: false,
                    createdAt: Date.now()
                };

                try {
                    await gameRef.set(initialGameData);
                    setGameRoomId(roomId);
                    setIsGameOwner(true);
                    return roomId;
                } catch (error) {
                    alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×—×“×¨: ' + error.message);
                }
            };

            const joinGameRoom = async (roomId) => {
                if (!database) {
                    throw new Error('Firebase ×œ× ××•×’×“×¨');
                }

                const gameRef = database.ref(`games/${roomId}`);
                const snapshot = await gameRef.once('value');
                const gameData = snapshot.val();

                if (!gameData) {
                    throw new Error('××©×—×§ ×œ× × ××¦×');
                }

                if (gameData.status !== 'waiting') {
                    throw new Error('×”××©×—×§ ×›×‘×¨ ×”×ª×—×™×œ');
                }

                const playerCount = Object.keys(gameData.players || {}).length;
                if (playerCount >= gameData.settings.playerCount) {
                    throw new Error('×”××©×—×§ ××œ×');
                }

                await gameRef.child(`players/${playerId}`).set({
                    id: playerId,
                    name: playerName,
                    totalScore: 0,
                    eliminated: false,
                    lastRoll: null,
                    isOnline: true,
                    joinedAt: Date.now()
                });

                setGameRoomId(roomId);
                setIsGameOwner(false);
            };

            const startOnlineGame = async () => {
                if (!isGameOwner || !gameRoomId || !database) {
                    console.log('âŒ Cannot start game - not owner or missing requirements');
                    return;
                }
                
                try {
                    const gameRef = database.ref(`games/${gameRoomId}`);
                    const snapshot = await gameRef.once('value');
                    const gameData = snapshot.val();
                    
                    if (!gameData) {
                        console.log('âŒ No game data found');
                        return;
                    }
                    
                    const activePlayers = Object.values(gameData.players).filter(p => !p.eliminated);
                    
                    if (activePlayers.length < 2) {
                        alert('×¦×¨×™×š ×œ×¤×—×•×ª 2 ×©×—×§× ×™× ×›×“×™ ×œ×”×ª×—×™×œ');
                        return;
                    }
                    
                    console.log('ğŸš€ Starting online game with', activePlayers.length, 'players');
                    
                    await gameRef.update({
                        status: 'playing',
                        currentPlayerIndex: 0,
                        gameRound: 1,
                        isRolling: false,
                        startedAt: Date.now()
                    });
                    
                    console.log('âœ… Game started successfully');
                    
                } catch (error) {
                    console.error('Error starting online game:', error);
                    alert('×©×’×™××” ×‘×”×ª×—×œ×ª ×”××©×—×§: ' + error.message);
                }
            };

            const rollDiceOnline = async () => {
                if (!gameData || !database || isRolling) {
                    console.log('âŒ Cannot roll - missing data, database, or already rolling');
                    return;
                }
                
                const currentPlayer = getCurrentPlayer();
                if (!currentPlayer || currentPlayer.id !== playerId) {
                    console.log('âŒ Not your turn or invalid player');
                    return;
                }
                
                // ×‘×“×™×§×” ×—×–×§×” ×™×•×ª×¨ - ×× ×”×©×—×§×Ÿ ×›×‘×¨ ×–×¨×§ ×‘×¡×™×‘×•×‘ ×”× ×•×›×—×™
                if (currentPlayer.lastRoll) {
                    console.log('âŒ Player already rolled this round');
                    alert('×›×‘×¨ ×–×¨×§×ª ×‘×¡×™×‘×•×‘ ×”×–×”! ×—×›×” ×œ×ª×•×¨ ×”×‘×.');
                    return;
                }
                
                console.log('âœ… Starting dice roll for player:', currentPlayer.name);
                setIsRolling(true);
                const gameRef = database.ref(`games/${gameRoomId}`);
                
                try {
                    // × ×¢×™×œ ××ª ×”×–×¨×™×§×” ×‘-Firebase
                    await gameRef.update({ isRolling: true });
                    
                    let rollCount = 0;
                    const maxRolls = 15;
                    
                    const rollInterval = setInterval(async () => {
                        rollCount++;
                        const tempDice = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1);
                        
                        await gameRef.update({ currentDice: tempDice });
                        
                        if (rollCount >= maxRolls) {
                            clearInterval(rollInterval);
                            
                            setTimeout(async () => {
                                const finalResults = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1);
                                const score = calculateScore(finalResults);
                                const combination = getScoreCombination(finalResults);
                                
                                console.log('ğŸ² Final dice results:', finalResults, 'Score:', score);
                                
                                // ×¢×“×›×•×Ÿ × ×ª×•× ×™ ×”×©×—×§×Ÿ ×‘-transaction ×›×“×™ ×œ×× ×•×¢ ×¢×“×›×•× ×™× ×›×¤×•×œ×™×
                                const playerRef = gameRef.child(`players/${playerId}`);
                                
                                await playerRef.transaction((currentData) => {
                                    if (!currentData) return currentData;
                                    
                                    // ×× ×”×©×—×§×Ÿ ×›×‘×¨ ×–×¨×§ - ××œ ×ª×¢×“×›×Ÿ ×©×•×‘
                                    if (currentData.lastRoll) {
                                        console.log('âš ï¸ Player already has a roll - skipping update');
                                        return currentData;
                                    }
                                    
                                    return {
                                        ...currentData,
                                        totalScore: (currentData.totalScore || 0) + score,
                                        lastRoll: {
                                            dice: finalResults,
                                            score: score,
                                            combination: combination,
                                            timestamp: Date.now()
                                        }
                                    };
                                });
                                
                                await gameRef.update({
                                    currentDice: finalResults,
                                    isRolling: false
                                });
                                
                                setIsRolling(false);
                                
                                console.log('âœ… Roll completed successfully');
                                
                                // ×¡×™××•×Ÿ ×©××ª×—×™×œ ××¢×‘×¨ ×ª×•×¨
                                setIsTransitioning(true);
                                
                                // ×¢×™×›×•×‘ ×§×¦×¨ ×œ××¢×‘×¨ ×ª×•×¨
                                setTimeout(async () => {
                                    console.log('ğŸ² Player finished rolling, checking for turn advance...');
                                    
                                    // ×‘×“×™×§×” × ×•×¡×¤×ª ×©×œ ××¦×‘ ×”××©×—×§ ×œ×¤× ×™ ××¢×‘×¨ ×ª×•×¨
                                    const checkSnapshot = await gameRef.once('value');
                                    const checkData = checkSnapshot.val();
                                    
                                    if (checkData && checkData.status === 'playing') {
                                        await checkAndAdvanceTurnFixed();
                                    }
                                    
                                    // ××™×¤×•×¡ ×”××¢×‘×¨ ××—×¨×™ ×¢×™×›×•×‘ × ×•×¡×£
                                    setTimeout(() => {
                                        setIsTransitioning(false);
                                    }, 500);
                                }, 1000);
                                
                            }, 500);
                        }
                    }, 120);
                    
                } catch (error) {
                    console.error('Error in rollDiceOnline:', error);
                    setIsRolling(false);
                    await gameRef.update({ isRolling: false });
                }
            };

            const checkAndAdvanceTurnFixed = async () => {
                if (!database || !gameRoomId) {
                    console.log('âŒ Cannot advance turn - missing database or room ID');
                    return;
                }
                
                try {
                    const gameRef = database.ref(`games/${gameRoomId}`);
                    const snapshot = await gameRef.once('value');
                    const currentGame = snapshot.val();
                    
                    if (!currentGame || currentGame.status !== 'playing') {
                        console.log('âŒ Game not in playing state');
                        return;
                    }
                    
                    const activePlayers = Object.values(currentGame.players)
                        .filter(p => !p.eliminated)
                        .sort((a, b) => a.joinedAt - b.joinedAt);
                    
                    const playersWithRolls = activePlayers.filter(p => p.lastRoll);
                    
                    console.log('=== Checking Turn Advance ===');
                    console.log('Active players:', activePlayers.length);
                    console.log('Players with rolls:', playersWithRolls.length);
                    console.log('Current player index:', currentGame.currentPlayerIndex);
                    
                    if (currentGame.currentPlayerIndex >= activePlayers.length) {
                        console.log('âš ï¸ Invalid player index, resetting to 0');
                        await gameRef.update({ currentPlayerIndex: 0 });
                        return;
                    }
                    
                    // ×× ×›×œ ×”×©×—×§× ×™× ×–×¨×§×• - ×¢×•×‘×¨ ×œ×¡×™×‘×•×‘ ×—×“×©
                    if (playersWithRolls.length === activePlayers.length && activePlayers.length > 1) {
                        console.log('ğŸ”„ All players rolled - ending round');
                        await endRoundAndEliminate(gameRef, currentGame, activePlayers);
                    } 
                    // ×× ×¢×“×™×™×Ÿ ×™×© ×©×—×§× ×™× ×©×œ× ×–×¨×§×• - ×¢×•×‘×¨ ×œ×©×—×§×Ÿ ×”×‘×
                    else if (playersWithRolls.length < activePlayers.length) {
                        console.log('â¡ï¸ Moving to next player');
                        await moveToNextPlayer(gameRef, currentGame, activePlayers);
                    }
                    // ×× ×™×© ×¨×§ ×©×—×§×Ÿ ××—×“ ×¤×¢×™×œ - ×”××©×—×§ ×”×¡×ª×™×™×
                    else if (activePlayers.length === 1) {
                        console.log('ğŸ† Only one player left - game finished');
                        await gameRef.update({
                            status: 'finished',
                            winner: activePlayers[0]?.id || null,
                            finishedAt: Date.now()
                        });
                    }
                    
                } catch (error) {
                    console.error('Error in checkAndAdvanceTurnFixed:', error);
                }
            };

            const moveToNextPlayer = async (gameRef, currentGame, activePlayers) => {
                try {
                    const currentIndex = currentGame.currentPlayerIndex || 0;
                    const playersWithRolls = activePlayers.filter(p => p.lastRoll);
                    
                    // ×× ×›×œ ×”×©×—×§× ×™× ×–×¨×§×• - ×œ× ×¦×¨×™×š ×œ×¢×‘×•×¨ ×œ×©×—×§×Ÿ ×”×‘×, ×¦×¨×™×š ×œ×¡×™×™× ×¡×™×‘×•×‘
                    if (playersWithRolls.length === activePlayers.length) {
                        console.log('âš ï¸ All players have rolled - should end round instead');
                        return;
                    }
                    
                    // ×—×™×¤×•×© ×”×©×—×§×Ÿ ×”×‘× ×©×œ× ×–×¨×§ ×¢×“×™×™×Ÿ
                    for (let i = 1; i <= activePlayers.length; i++) {
                        const nextIndex = (currentIndex + i) % activePlayers.length;
                        const nextPlayer = activePlayers[nextIndex];
                        
                        if (nextPlayer && !nextPlayer.lastRoll && !nextPlayer.eliminated) {
                            console.log('ğŸ¯ Moving to player:', nextPlayer.name, 'at index:', nextIndex);
                            
                            // ×©×™××•×© ×‘-transaction ×›×“×™ ×œ×× ×•×¢ ×”×ª× ×’×©×•×™×•×ª
                            await gameRef.child('currentPlayerIndex').transaction(() => {
                                return nextIndex;
                            });
                            
                            await gameRef.update({ isRolling: false });
                            return;
                        }
                    }
                    
                    // ×× ×”×’×¢× ×• ×œ×›××Ÿ, ×›×œ ×”×©×—×§× ×™× ×–×¨×§×• - ×¦×¨×™×š ×œ×¡×™×™× ×¡×™×‘×•×‘
                    console.log('âš ï¸ No player found without roll - ending round');
                    await endRoundAndEliminate(gameRef, currentGame, activePlayers);
                    
                } catch (error) {
                    console.error('Error in moveToNextPlayer:', error);
                }
            };

            // ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×¡×™×•× ×¡×™×‘×•×‘ - ×ª×•××›×ª ×‘×©× ×™ ×¡×•×’×™ ××©×—×§
            const endRoundAndEliminate = async (gameRef, currentGame, activePlayers) => {
                try {
                    const checkSnapshot = await gameRef.once('value');
                    const recentData = checkSnapshot.val();
                    
                    if (recentData.gameRound > currentGame.gameRound) {
                        console.log('ğŸ”„ Round already updated by another player');
                        return;
                    }
                    
                    const updates = {};
                    
                    // × ×™×§×•×™ ×–×¨×™×§×•×ª
                    Object.keys(currentGame.players).forEach(playerId => {
                        updates[`players/${playerId}/lastRoll`] = null;
                    });
                    
                    const currentRound = currentGame.gameRound || 1;
                    const gameType = currentGame.settings?.gameType || 1;
                    
                    if (gameType === 1) {
                        // ××©×—×§ ×”×™×©×¨×“×•×ª - ×¤×¡×™×œ×ª ×”×©×—×§×Ÿ ×¢× ×”× ×™×§×•×“ ×”× ××•×š
                        const lowestScore = Math.min(...activePlayers.map(p => p.totalScore || 0));
                        const playersToEliminate = activePlayers.filter(p => (p.totalScore || 0) === lowestScore);
                        
                        console.log('ğŸ’€ Eliminating players with score:', lowestScore);
                        console.log('Players to eliminate:', playersToEliminate.map(p => p.name));
                        
                        playersToEliminate.forEach(player => {
                            updates[`players/${player.id}/eliminated`] = true;
                        });
                        
                        const remainingPlayers = activePlayers.filter(p => !playersToEliminate.includes(p));
                        
                        if (remainingPlayers.length <= 1) {
                            updates['status'] = 'finished';
                            updates['winner'] = remainingPlayers[0]?.id || null;
                            updates['finishedAt'] = Date.now();
                            console.log('ğŸ† Elimination Game finished!');
                        } else {
                            updates['gameRound'] = currentRound + 1;
                            updates['currentPlayerIndex'] = 0;
                        }
                        
                    } else if (gameType === 2) {
                        // ××©×—×§ 5 ×¡×™×‘×•×‘×™×
                        if (currentRound >= 5) {
                            const highestScore = Math.max(...activePlayers.map(p => p.totalScore || 0));
                            const winner = activePlayers.find(p => (p.totalScore || 0) === highestScore);
                            
                            updates['status'] = 'finished';
                            updates['winner'] = winner?.id || null;
                            updates['finishedAt'] = Date.now();
                            console.log('ğŸ† 5-Round Game finished! Winner:', winner?.name);
                        } else {
                            updates['gameRound'] = currentRound + 1;
                            updates['currentPlayerIndex'] = 0;
                            console.log('â¡ï¸ Moving to round', currentRound + 1, 'of 5');
                        }
                    }
                    
                    updates['currentDice'] = [];
                    updates['isRolling'] = false;
                    
                    await gameRef.child('gameRound').transaction((currentRound) => {
                        if (currentRound > (currentGame.gameRound || 1)) {
                            return currentRound;
                        }
                        return (currentGame.gameRound || 1) + 1;
                    });
                    
                    delete updates['gameRound'];
                    await gameRef.update(updates);
                    
                    console.log('âœ… Round ended successfully');
                    
                } catch (error) {
                    console.error('Error in endRoundAndEliminate:', error);
                }
            };

            const getCurrentPlayer = () => {
                if (!gameData || !gameData.players) {
                    console.log('âŒ No game data or players');
                    return null;
                }
                
                const activePlayers = Object.values(gameData.players)
                    .filter(p => !p.eliminated)
                    .sort((a, b) => a.joinedAt - b.joinedAt);
                
                const currentIndex = gameData.currentPlayerIndex || 0;
                
                if (currentIndex < 0 || currentIndex >= activePlayers.length) {
                    console.log('âš ï¸ Invalid player index:', currentIndex, 'for', activePlayers.length, 'players');
                    return activePlayers[0] || null; // ×—×–×•×¨ ×œ×©×—×§×Ÿ ×”×¨××©×•×Ÿ ×‘××§×¨×” ×©×œ ×©×’×™××”
                }
                
                const currentPlayer = activePlayers[currentIndex];
                
                console.log('=== Current Player Debug ===');
                console.log('Active players:', activePlayers.map(p => p.name));
                console.log('Current index:', currentIndex);
                console.log('Current player:', currentPlayer?.name);
                console.log('Player already rolled:', !!currentPlayer?.lastRoll);
                
                return currentPlayer;
            };

            // Local Game Functions
            const rollDiceLocal = () => {
                if (isRolling) return;
                
                setIsRolling(true);
                let rollCount = 0;
                const maxRolls = 15;
                
                const rollInterval = setInterval(() => {
                    rollCount++;
                    setDiceResults(Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1));
                    
                    if (rollCount >= maxRolls) {
                        clearInterval(rollInterval);
                        
                        setTimeout(() => {
                            const finalResults = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 1);
                            setDiceResults(finalResults);
                            
                            const score = calculateScore(finalResults);
                            const combination = getScoreCombination(finalResults);
                            
                            const newPlayers = [...players];
                            if (newPlayers[currentPlayerIndex]) {
                                newPlayers[currentPlayerIndex].totalScore += score;
                                newPlayers[currentPlayerIndex].lastRoll = {
                                    dice: finalResults,
                                    score: score,
                                    combination: combination
                                };
                                setPlayers(newPlayers);
                            }
                            
                            setIsRolling(false);
                            
                            setTimeout(() => {
                                nextTurnLocal();
                            }, 2000);
                        }, 500);
                    }
                }, 120);
            };

            // ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×¡×™×•× ×¡×™×‘×•×‘ ××§×•××™ - ×ª×•××›×ª ×‘×©× ×™ ×¡×•×’×™ ××©×—×§
            const nextTurnLocal = () => {
                const activePlayers = players.filter(p => !p.eliminated);
                const playersWithRolls = activePlayers.filter(p => p.lastRoll);
                
                console.log('Local game - Active players:', activePlayers.length);
                console.log('Local game - Players with rolls:', playersWithRolls.length);
                
                if (playersWithRolls.length === activePlayers.length && activePlayers.length > 1) {
                    if (gameSettings.gameType === 1) {
                        // ××©×—×§ ×”×™×©×¨×“×•×ª
                        const lowestScore = Math.min(...activePlayers.map(p => p.totalScore));
                        const lowestPlayers = activePlayers.filter(p => p.totalScore === lowestScore);
                        
                        const newPlayers = players.map(p => ({
                            ...p,
                            eliminated: p.eliminated || lowestPlayers.includes(p),
                            lastRoll: null
                        }));
                        
                        setPlayers(newPlayers);
                        setDiceResults([]);
                        
                        const remaining = newPlayers.filter(p => !p.eliminated);
                        if (remaining.length <= 1) {
                            setScreen('gameOver');
                            return;
                        }
                        
                        setGameRound(gameRound + 1);
                        setCurrentPlayerIndex(newPlayers.findIndex(p => !p.eliminated));
                        
                    } else if (gameSettings.gameType === 2) {
                        // ××©×—×§ 5 ×¡×™×‘×•×‘×™×
                        const newPlayers = players.map(p => ({
                            ...p,
                            lastRoll: null
                        }));
                        
                        setPlayers(newPlayers);
                        setDiceResults([]);
                        
                        if (gameRound >= 5) {
                            setScreen('gameOver');
                            return;
                        }
                        
                        setGameRound(gameRound + 1);
                        setCurrentPlayerIndex(0);
                    }
                } else {
                    // ××¢×‘×¨ ×œ×©×—×§×Ÿ ×”×‘×
                    let nextIndex = currentPlayerIndex;
                    let attempts = 0;
                    
                    do {
                        nextIndex = (nextIndex + 1) % players.length;
                        attempts++;
                    } while (attempts < players.length && 
                             players[nextIndex] && 
                             (players[nextIndex].eliminated || players[nextIndex].lastRoll));
                    
                    if (attempts < players.length) {
                        console.log('Moving to next player in local game:', players[nextIndex]?.name);
                        setCurrentPlayerIndex(nextIndex);
                    }
                }
            };

            // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×× ×¦×— ×‘××©×—×§ 5 ×¡×™×‘×•×‘×™×
            const getWinnerForFiveRounds = () => {
                if (gameMode === 'online') {
                    return connectedPlayers.reduce((winner, player) => 
                        (player.totalScore || 0) > (winner.totalScore || 0) ? player : winner
                    );
                } else {
                    return players.reduce((winner, player) => 
                        (player.totalScore || 0) > (winner.totalScore || 0) ? player : winner
                    );
                }
            };

            const addPlayerLocal = (name) => {
                if (!name || name.trim().length < 2) {
                    alert('×©× ×”×©×—×§×Ÿ ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª 2 ×ª×•×•×™×');
                    return false;
                }
                
                if (players.some(p => p.name === name.trim())) {
                    alert('×©× ×–×” ×›×‘×¨ ×§×™×™× - ×‘×—×¨ ×©× ××—×¨');
                    return false;
                }
                
                if (players.length < gameSettings.playerCount) {
                    setPlayers([...players, {
                        id: players.length + 1,
                        name: name.trim(),
                        totalScore: 0,
                        eliminated: false,
                        lastRoll: null
                    }]);
                    
                    if (players.length + 1 === gameSettings.playerCount) {
                        setScreen('game');
                    }
                    return true;
                }
                return false;
            };

            const resetGame = () => {
                setScreen('welcome');
                setGameMode('local');
                setGameRoomId('');
                setGameData(null);
                setConnectedPlayers([]);
                setIsGameOwner(false);
                setPlayers([]);
                setCurrentPlayerIndex(0);
                setGameRound(1);
                setDiceResults([]);
                setIsFirstPlayer(true);
                setGameSettings({ playerCount: 2, gameType: 1 });
                setPlayerName('');
                setIsTransitioning(false);
            };

            // Auto-transition to game when online game starts
            useEffect(() => {
                if (gameMode === 'online' && gameData?.status === 'playing' && screen === 'waitingRoom') {
                    setScreen('game');
                }
            }, [gameData?.status, gameMode, screen]);

            const rollDice = gameMode === 'online' ? rollDiceOnline : rollDiceLocal;

            // Rules Component
            if (showRules) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl p-6 max-w-2xl max-h-96 overflow-y-auto">
                            <h3 className="text-2xl font-bold mb-4">ğŸ² 012025-×”×•×¨××•×ª ×”××©×—×§</h3>
                            <div className="space-y-3 text-right">
                                <div>
                                    <h4 className="font-bold text-lg">×¡×•×’×™ ××©×—×§:</h4>
                                    <div className="text-sm space-y-2">
                                        <div className="bg-red-50 p-3 rounded">
                                            <div className="font-bold text-red-800">ğŸ”¥ ××©×—×§ ×”×™×©×¨×“×•×ª</div>
                                            <div>×‘×›×œ ×¡×™×‘×•×‘ ×”×©×—×§×Ÿ ×¢× ×”× ×™×§×•×“ ×”× ××•×š ×‘×™×•×ª×¨ × ×¤×¡×œ. ×”×× ×¦×— ×”×•× ×”×©×—×§×Ÿ ×”××—×¨×•×Ÿ ×©× ×©××¨!</div>
                                        </div>
                                        <div className="bg-blue-50 p-3 rounded">
                                            <div className="font-bold text-blue-800">ğŸ¯ ××©×—×§ 5 ×¡×™×‘×•×‘×™×</div>
                                            <div>5 ×¡×™×‘×•×‘×™× ×‘×œ×‘×“, ×•×”×× ×¦×— ×”×•× ×”×©×—×§×Ÿ ×¢× ×”× ×™×§×•×“ ×”×’×‘×•×” ×‘×™×•×ª×¨ ×‘×¡×•×£!</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 className="font-bold text-lg">××”×œ×š ×”××©×—×§:</h4>
                                    <ol className="list-decimal list-inside space-y-1">
                                        <li>×›×œ ×©×—×§×Ÿ ×‘×ª×•×¨×• ×–×•×¨×§ 5 ×§×•×‘×™×•×ª</li>
                                        <li>×”××¢×¨×›×ª ××—×©×‘×ª ××ª ×”× ×™×§×•×“ ×œ×¤×™ ×”×§×•××‘×™× ×¦×™×”</li>
                                        <li>×‘×¡×•×£ ×›×œ ×¡×™×‘×•×‘ ×™×© ×‘×“×™×§×” ×œ×¤×™ ×¡×•×’ ×”××©×—×§</li>
                                        <li>×”××©×—×§ ×××©×™×š ×¢×“ ×”× ×™×¦×—×•×Ÿ!</li>
                                    </ol>
                                </div>
                                
                                <div>
                                    <h4 className="font-bold text-lg">×˜×‘×œ×ª × ×™×§×•×“:</h4>
                                    <div className="text-sm space-y-1">
                                        <div>ğŸ¯ 5 ×–×”×•×ª: 5,000 Ã— ×”××¡×¤×¨</div>
                                        <div>ğŸ² ×¨×¦×£ ××œ×: 10,000 × ×§×•×“×•×ª</div>
                                        <div>ğŸ”¥ 4 ×–×”×•×ª: 1,500 Ã— ×”××¡×¤×¨</div>
                                        <div>ğŸ  ×¤×•×œ ×”××•×¡: 500 Ã— ×”××¡×¤×¨ ×©×œ ×”×©×œ×™×©×™×™×”</div>
                                        <div>âœ¨ 3 ×–×”×•×ª: 250 Ã— ×”××¡×¤×¨</div>
                                        <div>ğŸ‘¥ ×–×•×’ ×›×¤×•×œ: 100 Ã— ×”×–×•×’ ×”×’×‘×•×”</div>
                                        <div>ğŸ‘« ×–×•×’: 10 Ã— ×”××¡×¤×¨</div>
                                        <div>ğŸ¯ ×œ×œ× ×§×•××‘×™× ×¦×™×”: ×¡×›×•× ×›×œ ×”×§×•×‘×™×•×ª</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => setShowRules(false)}
                                className="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg w-full"
                            >
                                ×”×‘× ×ª×™!
                            </button>
                        </div>
                    </div>
                );
            }

            // Welcome Screen
            if (screen === 'welcome') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <div className="text-6xl mb-4 animate-bounce">ğŸ²</div>
                            <h2 className="text-3xl font-bold text-green-800 mb-2">××©×—×§ ×”×§×•×‘×™×•×ª</h2>
                            <h3 className="text-xl text-green-600 mb-8">×©×œ × ×•×¢×</h3>
                            
                            <div className="space-y-4">
                                {database ? (
                                    <button 
                                        onClick={() => {
                                            setGameMode('online');
                                            setScreen('nameEntry');
                                        }}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl w-full transition-all duration-300 transform hover:scale-105 mb-2"
                                    >
                                        ğŸŒ ××©×—×§ ××§×•×•×Ÿ
                                    </button>
                                ) : (
                                    <div className="bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded mb-4">
                                        <div className="text-sm">
                                            âš ï¸ Firebase ×œ× ××•×’×“×¨ - ×¨×§ ××©×—×§ ××§×•××™ ×–××™×Ÿ
                                        </div>
                                    </div>
                                )}
                                
                                <button 
                                    onClick={() => {
                                        setGameMode('local');
                                        setScreen('setup');
                                    }}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg text-xl w-full transition-all duration-300 transform hover:scale-105"
                                >
                                    ğŸ  ××©×—×§ ××§×•××™
                                </button>
                            </div>
                            
                            <button 
                                onClick={() => setShowRules(true)}
                                className="text-green-600 hover:text-green-700 underline mt-4"
                            >
                                ğŸ“‹ ×”×•×¨××•×ª ×”××©×—×§
                            </button>
                        </div>
                    </div>
                );
            }

            // Name Entry for Online - ×¢×“×›×•×Ÿ ×¢× ×‘×—×™×¨×ª ×¡×•×’ ××©×—×§
            if (screen === 'nameEntry') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">ğŸŒ ××©×—×§ ××§×•×•×Ÿ</h2>
                            
                            {/* ×‘×—×™×¨×ª ×¡×•×’ ××©×—×§ */}
                            <div className="mb-6">
                                <label className="block text-gray-700 font-bold mb-3">×¡×•×’ ×”××©×—×§</label>
                                <div className="space-y-3">
                                    <div 
                                        onClick={() => setGameSettings({...gameSettings, gameType: 1})}
                                        className={`p-4 border-2 rounded-lg cursor-pointer transition-all ${
                                            gameSettings.gameType === 1 
                                                ? 'border-blue-500 bg-blue-50' 
                                                : 'border-gray-300 hover:border-blue-300'
                                        }`}
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className={`w-4 h-4 rounded-full border-2 ${
                                                gameSettings.gameType === 1 
                                                    ? 'bg-blue-500 border-blue-500' 
                                                    : 'border-gray-300'
                                            }`}></div>
                                            <div className="text-right">
                                                <div className="font-bold text-gray-800">ğŸ”¥ ××©×—×§ ×”×™×©×¨×“×•×ª</div>
                                                <div className="text-sm text-gray-600">×›×œ ×¡×™×‘×•×‘ ×”×©×—×§×Ÿ ×¢× ×”× ×™×§×•×“ ×”× ××•×š × ×¤×¡×œ</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div 
                                        onClick={() => setGameSettings({...gameSettings, gameType: 2})}
                                        className={`p-4 border-2 rounded-lg cursor-pointer transition-all ${
                                            gameSettings.gameType === 2 
                                                ? 'border-green-500 bg-green-50' 
                                                : 'border-gray-300 hover:border-green-300'
                                        }`}
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className={`w-4 h-4 rounded-full border-2 ${
                                                gameSettings.gameType === 2 
                                                    ? 'bg-green-500 border-green-500' 
                                                    : 'border-gray-300'
                                            }`}></div>
                                            <div className="text-right">
                                                <div className="font-bold text-gray-800">ğŸ¯ ××©×—×§ 5 ×¡×™×‘×•×‘×™×</div>
                                                <div className="text-sm text-gray-600">5 ×¡×™×‘×•×‘×™× ×•×”×× ×¦×— ×¢× ×”× ×™×§×•×“ ×”×’×‘×•×”</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-gray-700 font-bold mb-2">×›××•×ª ×©×—×§× ×™×</label>
                                <select 
                                    value={gameSettings.playerCount}
                                    onChange={(e) => setGameSettings({...gameSettings, playerCount: parseInt(e.target.value)})}
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-center focus:border-blue-500 focus:outline-none mb-4"
                                >
                                    {[2,3,4,5,6,7,8,9].map(n => (
                                        <option key={n} value={n}>{n} ×©×—×§× ×™×</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-gray-700 font-bold mb-2">×”×›× ×¡ ××ª ×©××š</label>
                                <input 
                                    type="text"
                                    value={playerName}
                                    onChange={(e) => setPlayerName(e.target.value)}
                                    placeholder="×”×©× ×©×œ×š"
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-center focus:border-blue-500 focus:outline-none"
                                    maxLength="15"
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && playerName.trim()) {
                                            setScreen('onlineMenu');
                                        }
                                    }}
                                />
                            </div>
                            
                            <button 
                                onClick={() => playerName.trim() && setScreen('onlineMenu')}
                                disabled={!playerName.trim()}
                                className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg w-full mb-4 transition-all duration-300"
                            >
                                ×”××©×š
                            </button>
                            
                            <button 
                                onClick={() => setScreen('welcome')}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                â† ×—×–×•×¨
                            </button>
                        </div>
                    </div>
                );
            }

            // Online Menu
            if (screen === 'onlineMenu') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">×©×œ×•× {playerName}! ğŸ‘‹</h2>
                            <p className="text-gray-600 mb-2">×‘×—×¨ ××™×š ×ª×¨×¦×” ×œ×©×—×§:</p>
                            
                            {/* ×”×¦×’×ª ×”×”×’×“×¨×•×ª ×©× ×‘×—×¨×• */}
                            <div className="bg-gray-50 rounded-lg p-3 mb-6 text-sm">
                                <div className="font-bold text-gray-700">×”×”×’×“×¨×•×ª ×©×œ×š:</div>
                                <div className="text-gray-600">
                                    {gameSettings.gameType === 1 ? 'ğŸ”¥ ××©×—×§ ×”×™×©×¨×“×•×ª' : 'ğŸ¯ ××©×—×§ 5 ×¡×™×‘×•×‘×™×'} â€¢ 
                                    {gameSettings.playerCount} ×©×—×§× ×™×
                                </div>
                            </div>
                            
                            <div className="space-y-4">
                                <button 
                                    onClick={async () => {
                                        try {
                                            const roomId = await createGameRoom();
                                            if (roomId) {
                                                setScreen('waitingRoom');
                                            }
                                        } catch (error) {
                                            alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×—×“×¨: ' + error.message);
                                        }
                                    }}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg text-lg w-full transition-all duration-300 transform hover:scale-105"
                                >
                                    ğŸ  ×¦×•×¨ ×—×“×¨ ××©×—×§ ×—×“×©
                                </button>
                                
                                <div className="border-t pt-4">
                                    <label className="block text-gray-700 font-bold mb-2">××• ×”×¦×˜×¨×£ ×œ×—×“×¨ ×§×™×™×:</label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text"
                                            placeholder="×§×•×“ ×”×—×“×¨"
                                            className="flex-1 p-3 border-2 border-gray-300 rounded-lg text-center focus:border-blue-500 focus:outline-none uppercase"
                                            maxLength="6"
                                            value={gameRoomId}
                                            onChange={(e) => setGameRoomId(e.target.value.toUpperCase())}
                                        />
                                        <button 
                                            onClick={async () => {
                                                if (!gameRoomId) {
                                                    alert('×”×›× ×¡ ×§×•×“ ×—×“×¨');
                                                    return;
                                                }
                                                try {
                                                    await joinGameRoom(gameRoomId);
                                                    setScreen('waitingRoom');
                                                } catch (error) {
                                                    alert('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª: ' + error.message);
                                                }
                                            }}
                                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300"
                                        >
                                            ×”×¦×˜×¨×£
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => setScreen('nameEntry')}
                                className="text-gray-500 hover:text-gray-700 mt-6"
                            >
                                â† ×©× ×” ×”×’×“×¨×•×ª
                            </button>
                        </div>
                    </div>
                );
            }

            // Waiting Room
            if (screen === 'waitingRoom') {
                const gameTypeText = gameData?.settings?.gameType === 1 ? 'ğŸ”¥ ×”×™×©×¨×“×•×ª' : 'ğŸ¯ 5 ×¡×™×‘×•×‘×™×';
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">ğŸ  ×—×“×¨ ×”××ª× ×”</h2>
                            
                            <div className="bg-green-100 rounded-lg p-4 mb-4">
                                <div className="text-lg font-bold text-green-800">×§×•×“ ×”×—×“×¨:</div>
                                <div className="text-3xl font-bold text-green-600 tracking-widest">{gameRoomId}</div>
                                <div className="text-sm text-green-700 mt-2">×©×ª×£ ××ª ×”×§×•×“ ×”×–×” ×¢× ×”×—×‘×¨×™× ×©×œ×š!</div>
                            </div>
                            
                            <div className="bg-blue-50 rounded-lg p-3 mb-6">
                                <div className="font-bold text-blue-800">×¡×•×’ ×”××©×—×§:</div>
                                <div className="text-blue-600">{gameTypeText}</div>
                            </div>
                            
                            <div className="mb-6">
                                <h3 className="font-bold text-lg mb-3">×©×—×§× ×™× ××—×•×‘×¨×™×:</h3>
                                <div className="space-y-2">
                                    {connectedPlayers.map((player, index) => (
                                        <div key={player.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div className="flex items-center gap-2">
                                                <span>{avatarEmojis[index]}</span>
                                                <span className="font-medium">{player.name}</span>
                                                {player.id === playerId && <span className="text-blue-600">(××ª×”)</span>}
                                                {gameData?.owner === player.id && <span className="text-green-600">ğŸ‘‘</span>}
                                            </div>
                                            <div className="online-indicator w-3 h-3 bg-green-500 rounded-full"></div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="text-sm text-gray-600 mt-3">
                                    {connectedPlayers.length}/{gameData?.settings?.playerCount || 2} ×©×—×§× ×™×
                                </div>
                            </div>
                            
                            {isGameOwner && connectedPlayers.length >= 2 && (
                                <button 
                                    onClick={async () => {
                                        await startOnlineGame();
                                        setScreen('game');
                                    }}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg text-lg w-full transition-all duration-300 transform hover:scale-105 mb-4"
                                >
                                    ğŸš€ ×”×ª×—×œ ××©×—×§!
                                </button>
                            )}
                            
                            {!isGameOwner && (
                                <div className="bg-blue-100 rounded-lg p-4 mb-4">
                                    <div className="text-blue-800">â³ ×××ª×™×Ÿ ×©×× ×”×œ ×”×—×“×¨ ×™×ª×—×™×œ ××ª ×”××©×—×§...</div>
                                </div>
                            )}
                            
                            <button 
                                onClick={() => {
                                    if (gameRoomId && database) {
                                        database.ref(`games/${gameRoomId}/players/${playerId}`).remove();
                                    }
                                    resetGame();
                                }}
                                className="text-red-500 hover:text-red-700"
                            >
                                ğŸšª ×¢×–×•×‘ ×—×“×¨
                            </button>
                        </div>
                    </div>
                );
            }

            // Local Setup Screen - ×¢×“×›×•×Ÿ ×¢× ×‘×—×™×¨×ª ×¡×•×’ ××©×—×§
            if (screen === 'setup') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">ğŸ  ××©×—×§ ××§×•××™</h2>
                            
                            {isFirstPlayer && (
                                <>
                                    {/* ×‘×—×™×¨×ª ×¡×•×’ ××©×—×§ */}
                                    <div className="mb-6">
                                        <label className="block text-gray-700 font-bold mb-3">×¡×•×’ ×”××©×—×§</label>
                                        <div className="space-y-3">
                                            <div 
                                                onClick={() => setGameSettings({...gameSettings, gameType: 1})}
                                                className={`p-3 border-2 rounded-lg cursor-pointer transition-all ${
                                                    gameSettings.gameType === 1 
                                                        ? 'border-blue-500 bg-blue-50' 
                                                        : 'border-gray-300 hover:border-blue-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-2">
                                                    <div className={`w-3 h-3 rounded-full border-2 ${
                                                        gameSettings.gameType === 1 
                                                            ? 'bg-blue-500 border-blue-500' 
                                                            : 'border-gray-300'
                                                    }`}></div>
                                                    <div className="text-right text-sm">
                                                        <div className="font-bold">ğŸ”¥ ×”×™×©×¨×“×•×ª</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div 
                                                onClick={() => setGameSettings({...gameSettings, gameType: 2})}
                                                className={`p-3 border-2 rounded-lg cursor-pointer transition-all ${
                                                    gameSettings.gameType === 2 
                                                        ? 'border-green-500 bg-green-50' 
                                                        : 'border-gray-300 hover:border-green-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-2">
                                                    <div className={`w-3 h-3 rounded-full border-2 ${
                                                        gameSettings.gameType === 2 
                                                            ? 'bg-green-500 border-green-500' 
                                                            : 'border-gray-300'
                                                    }`}></div>
                                                    <div className="text-right text-sm">
                                                        <div className="font-bold">ğŸ¯ 5 ×¡×™×‘×•×‘×™×</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-6">
                                        <label className="block text-gray-700 font-bold mb-2">×›××•×ª ×©×—×§× ×™×</label>
                                        <select 
                                            value={gameSettings.playerCount}
                                            onChange={(e) => setGameSettings({...gameSettings, playerCount: parseInt(e.target.value)})}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-center focus:border-green-500 focus:outline-none"
                                        >
                                            {[2,3,4,5,6,7,8,9].map(n => (
                                                <option key={n} value={n}>{n} ×©×—×§× ×™×</option>
                                            ))}
                                        </select>
                                    </div>
                                </>
                            )}
                            
                            <div className="mb-6">
                                <label className="block text-gray-700 font-bold mb-2">
                                    {isFirstPlayer ? 'ğŸ‘¤ ×”×©×—×§×Ÿ ×”×¨××©×•×Ÿ' : 'ğŸ‘¥ ×”×¦×˜×¨×£ ×œ××©×—×§'}
                                </label>
                                <input 
                                    id="playerNameInput"
                                    type="text"
                                    placeholder={isFirstPlayer ? "×”×›× ×¡ ××ª ×©××š (×™×•×¦×¨ ×”×©×•×œ×—×Ÿ)" : "×”×›× ×¡ ××ª ×©××š"}
                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-center focus:border-green-500 focus:outline-none"
                                    maxLength="15"
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && e.target.value.trim()) {
                                            if (addPlayerLocal(e.target.value.trim())) {
                                                e.target.value = '';
                                                if (players.length + 1 < gameSettings.playerCount) {
                                                    setIsFirstPlayer(false);
                                                }
                                            }
                                        }
                                    }}
                                />
                            </div>
                            
                            <button 
                                onClick={() => {
                                    const input = document.getElementById('playerNameInput');
                                    if (input && input.value.trim()) {
                                        if (addPlayerLocal(input.value.trim())) {
                                            input.value = '';
                                            if (players.length + 1 < gameSettings.playerCount) {
                                                setIsFirstPlayer(false);
                                            }
                                        }
                                    } else {
                                        alert('×× × ×”×›× ×¡ ×©×');
                                    }
                                }}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg w-full mb-4 transition-all duration-300 transform hover:scale-105"
                            >
                                {players.length === 0 ? 'ğŸ¯ ×™×¦×™×¨×ª ×©×•×œ×—×Ÿ' : 'ğŸ‘¥ ×”×¦×˜×¨×¤×•×ª ×œ×©×•×œ×—×Ÿ'}
                            </button>
                            
                            {players.length > 0 && (
                                <div className="text-gray-600 bg-gray-50 rounded-lg p-4 mb-4">
                                    <div className="font-bold mb-2">
                                        ×©×—×§× ×™× ×‘××©×—×§: {players.length}/{gameSettings.playerCount}
                                    </div>
                                    <div className="text-sm text-blue-600 mb-2">
                                        {gameSettings.gameType === 1 ? 'ğŸ”¥ ××©×—×§ ×”×™×©×¨×“×•×ª' : 'ğŸ¯ ××©×—×§ 5 ×¡×™×‘×•×‘×™×'}
                                    </div>
                                    <div className="space-y-1">
                                        {players.map((p, index) => (
                                            <div key={p.id} className="text-sm flex items-center justify-center gap-2">
                                                <span>{avatarEmojis[index]}</span>
                                                <span>{p.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                    {players.length < gameSettings.playerCount && (
                                        <div className="text-sm text-blue-600 mt-2 animate-pulse">
                                            â³ ×××ª×™×Ÿ ×œ×¢×•×“ {gameSettings.playerCount - players.length} ×©×—×§× ×™×...
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <button 
                                onClick={() => setScreen('welcome')}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                â† ×—×–×•×¨
                            </button>
                        </div>
                    </div>
                );
            }

            // Main Game Screen
            if (screen === 'game') {
                const currentPlayers = gameMode === 'online' ? connectedPlayers : players;
                const currentIndex = gameMode === 'online' ? gameData?.currentPlayerIndex || 0 : currentPlayerIndex;
                const currentRound = gameMode === 'online' ? gameData?.gameRound || 1 : gameRound;
                const currentDice = gameMode === 'online' ? gameData?.currentDice || [] : diceResults;
                const currentPlayer = gameMode === 'online' ? getCurrentPlayer() : currentPlayers[currentIndex];
                const isMyTurn = gameMode === 'online' ? (currentPlayer?.id === playerId && !isTransitioning) : true;
                const gameIsRolling = gameMode === 'online' ? gameData?.isRolling || false : isRolling;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 p-4">
                        <div className="w-full max-w-6xl mx-auto">
                            {/* Header */}
                            <div className="flex justify-between items-center mb-6">
                                <button
                                    onClick={() => setSoundEnabled(!soundEnabled)}
                                    className="bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition-all duration-300"
                                >
                                    {soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}
                                </button>

                                <div className="text-center text-white bg-black bg-opacity-30 rounded-xl px-6 py-3">
                                    <h2 className="text-xl font-bold">
                                        ğŸ² {getGameTypeDisplay()}
                                        {gameMode === 'online' && <span className="text-green-300 ml-2">ğŸŒ</span>}
                                    </h2>
                                    <p className="text-sm">
                                        ×ª×•×¨: <span className="font-bold text-yellow-300">{currentPlayer?.name}</span>
                                        {gameMode === 'online' && isMyTurn && <span className="text-green-300"> (×©×œ×š!)</span>}
                                    </p>
                                    {gameMode === 'online' && (
                                        <p className="text-xs text-gray-300">×—×“×¨: {gameRoomId}</p>
                                    )}
                                </div>

                                <button
                                    onClick={() => {
                                        if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ×¢×–×•×‘ ××ª ×”××©×—×§?')) {
                                            if (gameMode === 'online' && gameRoomId && database) {
                                                database.ref(`games/${gameRoomId}/players/${playerId}`).remove();
                                            }
                                            resetGame();
                                        }
                                    }}
                                    className="bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition-all duration-300"
                                >
                                    ğŸšª
                                </button>
                            </div>

                            {/* Game Table */}
                            <div className="relative w-full h-96 mx-auto max-w-6xl">
                                <div className="w-full h-full bg-gradient-to-br from-green-600 to-green-700 shadow-2xl" 
                                     style={{
                                         borderRadius: '50%/35%',
                                         border: '12px solid #d97706',
                                         boxShadow: 'inset 0 0 50px rgba(0,0,0,0.3), 0 20px 40px rgba(0,0,0,0.4)'
                                     }}>
                                    
                                    <div className="absolute inset-4 bg-gradient-to-br from-green-500 to-green-600 opacity-90" 
                                         style={{borderRadius: '50%/35%'}}></div>
                                    
                                    <div className="absolute top-1/2 left-1/4 right-1/4 h-0.5 bg-yellow-600 opacity-50 transform -translate-y-1/2"></div>
                                    
                                    {/* Players */}
                                    {currentPlayers.map((player, index) => {
                                        const pos = getPlayerPosition(index, currentPlayers.length);
                                        const isCurrentPlayerTurn = gameMode === 'online' ? 
                                            (getCurrentPlayer()?.id === player.id) : 
                                            (index === currentIndex);
                                        const isEliminated = player.eliminated;
                                        const isMe = gameMode === 'online' ? player.id === playerId : false;
                                        
                                        return (
                                            <div key={player.id || index}>
                                                <div
                                                    className={`absolute transform -translate-x-1/2 -translate-y-1/2 text-center transition-all duration-500 z-10 ${
                                                        isEliminated ? 'opacity-30 grayscale' : ''
                                                    } ${isCurrentPlayerTurn && !isEliminated ? 'scale-110' : ''}`}
                                                    style={{ left: pos.x, top: pos.y }}
                                                >
                                                    <div className={`w-20 h-20 ${avatarGradients[index]} rounded-full flex items-center justify-center text-3xl mb-2 shadow-lg border-4 border-white transition-all duration-500 ${
                                                        isCurrentPlayerTurn && !isEliminated ? 'player-glow' : ''
                                                    } ${isMe ? 'ring-4 ring-blue-400' : ''}`}>
                                                        {isEliminated ? 'ğŸ’€' : avatarEmojis[index]}
                                                    </div>
                                                    
                                                    <div className={`text-white text-sm font-bold mb-1 bg-black bg-opacity-50 rounded px-2 py-1 ${
                                                        isCurrentPlayerTurn && !isEliminated ? 'text-yellow-300' : ''
                                                    }`}>
                                                        {player.name}
                                                        {isMe && <span className="text-blue-300"> (××ª×”)</span>}
                                                    </div>
                                                    
                                                    <div className={`text-sm font-bold mb-2 bg-black bg-opacity-60 rounded px-2 py-1 ${
                                                        isEliminated ? 'text-gray-400' : 'text-yellow-300'
                                                    }`}>
                                                        {(player.totalScore || 0).toLocaleString()} × ×§'
                                                    </div>
                                                    
                                                    {player.lastRoll && !isEliminated && (
                                                        <div className="text-xs text-gray-200 mt-1 bg-black bg-opacity-70 rounded px-2 py-1">
                                                            {player.lastRoll.combination}<br/>
                                                            <span className="text-green-300">+{player.lastRoll.score}</span>
                                                        </div>
                                                    )}
                                                </div>

                                                {player.lastRoll && !isEliminated && (
                                                    <div
                                                        className="absolute transform -translate-x-1/2 -translate-y-1/2 z-10"
                                                        style={{ 
                                                            left: `${parseFloat(pos.x) + (index % 2 === 0 ? 12 : -12)}%`, 
                                                            top: `${parseFloat(pos.y) + (index < currentPlayers.length/2 ? 6 : -6)}%` 
                                                        }}
                                                    >
                                                        <div className="flex gap-1 bg-black bg-opacity-70 rounded p-1">
                                                            {player.lastRoll.dice.map((dice, diceIndex) => (
                                                                <div
                                                                    key={diceIndex}
                                                                    className="w-7 h-7 bg-white rounded text-black text-sm flex items-center justify-center font-bold border shadow-lg"
                                                                >
                                                                    {dice}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}

                                    {/* Central Dice Area */}
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30">
                                        {currentDice.length > 0 && gameIsRolling && (
                                            <div className="flex gap-3 mb-6">
                                                {currentDice.map((dice, index) => (
                                                    <div
                                                        key={index}
                                                        className={`w-20 h-20 bg-white rounded-xl flex items-center justify-center text-4xl font-bold shadow-2xl border-4 border-gray-600 ${
                                                            gameIsRolling ? 'dice-roll' : ''
                                                        }`}
                                                    >
                                                        {dice}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {!gameIsRolling && ((gameMode === 'online' && isMyTurn) || (gameMode === 'local')) && !currentPlayer?.lastRoll && currentPlayer ? (
                                            <button
                                                onClick={rollDice}
                                                disabled={gameIsRolling || (gameMode === 'online' && currentPlayer?.lastRoll)}
                                                className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed text-white font-bold py-6 px-12 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 disabled:hover:scale-100"
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-4xl animate-bounce">ğŸ²</span>
                                                    <div>
                                                        <div className="text-2xl">×–×¨×•×§ ×§×•×‘×™×•×ª</div>
                                                        <div className="text-sm opacity-90">
                                                            {gameMode === 'online' ? '×”×ª×•×¨ ×©×œ×š!' : currentPlayer?.name}
                                                        </div>
                                                    </div>
                                                    <span className="text-4xl animate-bounce" style={{animationDelay: '0.2s'}}>ğŸ²</span>
                                                </div>
                                            </button>
                                        ) : gameIsRolling ? (
                                            <div className="text-white font-bold text-xl bg-black bg-opacity-70 rounded-xl px-8 py-6 shadow-2xl">
                                                <div className="flex items-center gap-4">
                                                    <span className="text-4xl animate-spin">ğŸ²</span>
                                                    <div>
                                                        <div className="text-2xl">×–×•×¨×§ ×§×•×‘×™×•×ª...</div>
                                                        <div className="text-sm">{currentPlayer?.name}</div>
                                                    </div>
                                                    <span className="text-4xl animate-spin" style={{animationDelay: '0.5s'}}>ğŸ²</span>
                                                </div>
                                            </div>
                                        ) : (gameMode === 'online' && !isMyTurn) ? (
                                            <div className="text-white font-bold text-lg bg-blue-900 bg-opacity-80 rounded-xl px-6 py-4">
                                                <div className="text-center">
                                                    <div className="text-sm">×ª×•×¨ ×©×œ {currentPlayer?.name}...</div>
                                                    <div>â³</div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-white font-bold text-lg bg-green-900 bg-opacity-80 rounded-xl px-6 py-4">
                                                <div className="text-center">
                                                    <div className="text-sm">×××ª×™×Ÿ ×œ×©×—×§×Ÿ ×”×‘×...</div>
                                                    <div>â³</div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Leaderboard */}
                            <div className="mt-6 bg-white bg-opacity-10 rounded-xl p-4 max-w-md mx-auto">
                                <h3 className="text-white font-bold text-center mb-3">
                                    ğŸ† ×œ×•×— ×ª×•×¦××•×ª
                                    {gameMode === 'online' && <span className="text-green-300 ml-2">ğŸŒ</span>}
                                </h3>
                                <div className="space-y-2">
                                    {currentPlayers
                                        .filter(p => !p.eliminated)
                                        .sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0))
                                        .map((player, index) => (
                                            <div key={player.id || index} className={`flex items-center justify-between p-2 rounded-lg ${
                                                index === 0 ? 'bg-yellow-500 bg-opacity-30' : 
                                                index === 1 ? 'bg-gray-400 bg-opacity-30' : 
                                                index === 2 ? 'bg-orange-500 bg-opacity-30' : 
                                                'bg-white bg-opacity-10'
                                            } ${gameMode === 'online' && player.id === playerId ? 'ring-2 ring-blue-400' : ''}`}>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-lg">
                                                        {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                                    </span>
                                                    <span className="text-white font-bold">
                                                        {player.name}
                                                        {gameMode === 'online' && player.id === playerId && ' (××ª×”)'}
                                                    </span>
                                                </div>
                                                <span className="text-white font-bold">{(player.totalScore || 0).toLocaleString()}</span>
                                            </div>
                                        ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Game Over Screen
            if (screen === 'gameOver' || (gameMode === 'online' && gameData?.status === 'finished')) {
                let winner;
                
                if (gameMode === 'online') {
                    if (gameData?.settings?.gameType === 2) {
                        // ×‘××©×—×§ 5 ×¡×™×‘×•×‘×™× - ×”×× ×¦×— ×¢× ×”× ×™×§×•×“ ×”×’×‘×•×”
                        winner = getWinnerForFiveRounds();
                    } else {
                        // ×‘××©×—×§ ×”×™×©×¨×“×•×ª - ×”×©×—×§×Ÿ ×©×œ× × ×¤×¡×œ
                        winner = connectedPlayers.find(p => p.id === gameData?.winner);
                    }
                } else {
                    if (gameSettings.gameType === 2) {
                        // ×‘××©×—×§ 5 ×¡×™×‘×•×‘×™× ××§×•××™ - ×”×× ×¦×— ×¢× ×”× ×™×§×•×“ ×”×’×‘×•×”
                        winner = getWinnerForFiveRounds();
                    } else {
                        // ×‘××©×—×§ ×”×™×©×¨×“×•×ª ××§×•××™ - ×”×©×—×§×Ÿ ×©×œ× × ×¤×¡×œ
                        winner = players.find(p => !p.eliminated);
                    }
                }

                const gameTypeText = (gameMode === 'online' ? gameData?.settings?.gameType : gameSettings.gameType) === 1 ? 
                    '××©×—×§ ×”×™×©×¨×“×•×ª' : '××©×—×§ 5 ×¡×™×‘×•×‘×™×';

                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4">
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-lg w-full">
                            <div className="text-8xl mb-6 animate-bounce">ğŸ†</div>
                            <h2 className="text-4xl font-bold text-yellow-600 mb-4">
                                {winner?.name}
                            </h2>
                            <p className="text-2xl text-gray-700 mb-2">ğŸ‰ ×× ×¦×—! ğŸ‰</p>
                            <p className="text-lg text-gray-600 mb-2">{gameTypeText}</p>
                            <p className="text-xl text-gray-600 mb-6">
                                × ×™×§×•×“ ×¡×•×¤×™: <span className="font-bold text-green-600">
                                    {(winner?.totalScore || 0).toLocaleString()}
                                </span> × ×§×•×“×•×ª
                            </p>
                            
                            <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                <h3 className="font-bold text-lg mb-3">ğŸ… ×“×™×¨×•×’ ×¡×•×¤×™</h3>
                                <div className="space-y-2">
                                    {(gameMode === 'online' ? connectedPlayers : players)
                                        .sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0))
                                        .map((player, index) => (
                                            <div key={player.id || index} className={`flex items-center justify-between p-2 rounded ${
                                                !player.eliminated || (gameMode === 'online' ? gameData?.settings?.gameType : gameSettings.gameType) === 2 ? 'bg-yellow-200' : 'bg-gray-200'
                                            } ${gameMode === 'online' && player.id === playerId ? 'ring-2 ring-blue-400' : ''}`}>
                                                <div className="flex items-center gap-2">
                                                    <span>
                                                        {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                                    </span>
                                                    <span className={(!player.eliminated || (gameMode === 'online' ? gameData?.settings?.gameType : gameSettings.gameType) === 2) ? 'font-bold' : 'line-through'}>
                                                        {player.name}
                                                        {gameMode === 'online' && player.id === playerId && ' (××ª×”)'}
                                                    </span>
                                                </div>
                                                <span className="font-bold">{(player.totalScore || 0).toLocaleString()}</span>
                                            </div>
                                        ))}
                                </div>
                            </div>
                            
                            <button
                                onClick={() => {
                                    if (gameMode === 'online' && gameRoomId && database) {
                                        database.ref(`games/${gameRoomId}/players/${playerId}`).remove();
                                    }
                                    resetGame();
                                }}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg w-full transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-3"
                            >
                                ğŸ”„
                                <span className="text-xl">××©×—×§ ×—×“×©</span>
                                <span className="text-2xl">ğŸ²</span>
                            </button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<DiceGame />, document.getElementById('root'));
    </script>
</body>
</html>
