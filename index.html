<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק הקוביות של נועם</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 255, 0, 0.8); }
        }
        .player-glow {
            animation: glow 1s ease-in-out infinite;
        }
        @keyframes diceRoll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(90deg) rotateY(90deg); }
            50% { transform: rotateX(180deg) rotateY(180deg); }
            75% { transform: rotateX(270deg) rotateY(270deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        .dice-roll {
            animation: diceRoll 0.1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Firebase Configuration - החלף עם הקונפיגורציה שלך
const firebaseConfig = {
  apiKey: "AIzaSyAgWTlNnhRHQ_iGt10EgFuxkib-Z-ifa7s",
  authDomain: "noam-s-dice-game.firebaseapp.com",
  databaseURL: "https://noam-s-dice-game-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "noam-s-dice-game",
  storageBucket: "noam-s-dice-game.firebasestorage.app",
  messagingSenderId: "504625659348",
  appId: "1:504625659348:web:718a1b6b6317bf45cdea41",
  measurementId: "G-H0P3KWLM1P"
};

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        const { useState, useEffect, useRef } = React;

        const DiceGame = () => {
            const [screen, setScreen] = useState('welcome');
            const [playerName, setPlayerName] = useState('');
            const [gameId, setGameId] = useState('');
            const [playerId, setPlayerId] = useState('');
            const [gameSettings, setGameSettings] = useState({ playerCount: 2, gameType: 1 });
            const [players, setPlayers] = useState([]);
            
            const gameRef = useRef(null);

            // Generate unique IDs
            const generateId = () => Math.random().toString(36).substr(2, 9);

            // Create game function
            const createGame = async () => {
                console.log('מתחיל יצירת שולחן...');
                const newGameId = generateId();
                const newPlayerId = generateId();
                
                console.log(`ID שולחן: ${newGameId}, ID שחקן: ${newPlayerId}`);
                
                const gameData = {
                    id: newGameId,
                    status: 'waiting',
                    settings: gameSettings,
                    players: {
                        [newPlayerId]: {
                            id: newPlayerId,
                            name: playerName,
                            totalScore: 0,
                            eliminated: false,
                            lastRoll: null,
                            isHost: true,
                            joinedAt: Date.now()
                        }
                    },
                    currentPlayerIndex: 0,
                    gameRound: 1,
                    turnTimer: 10,
                    createdAt: Date.now()
                };

                try {
                    console.log('שולח נתונים ל-Firebase...');
                    await database.ref(`games/${newGameId}`).set(gameData);
                    console.log('✅ שולחן נוצר בהצלחה!');
                    
                    setGameId(newGameId);
                    setPlayerId(newPlayerId);
                    gameRef.current = database.ref(`games/${newGameId}`);
                    setScreen('waiting');
                    alert(`שולחן נוצר! קוד השולחן: ${newGameId}`);
                } catch (error) {
                    console.error('❌ שגיאה ביצירת השולחן:', error);
                    alert('שגיאה ביצירת השולחן: ' + error.message);
                }
            };

            // Join game function
            const joinGame = async () => {
                console.log('🚀 מתחיל הצטרפות לשולחן...');
                console.log('שם שחקן:', playerName);
                console.log('קוד שולחן:', gameId);
                
                const newPlayerId = generateId();
                console.log('ID שחקן חדש:', newPlayerId);
                
                try {
                    console.log('🔍 מחפש שולחן ב-Firebase...');
                    const gameSnapshot = await database.ref(`games/${gameId}`).once('value');
                    const existingGame = gameSnapshot.val();
                    
                    console.log('תוצאות חיפוש:', existingGame);
                    
                    if (!existingGame) {
                        console.error('❌ שולחן לא נמצא!');
                        alert('שולחן לא נמצא! בדוק את הקוד.');
                        return;
                    }
                    
                    console.log('✅ שולחן נמצא! סטטוס:', existingGame.status);
                    
                    if (existingGame.status !== 'waiting') {
                        console.error('❌ המשחק כבר התחיל!');
                        alert('המשחק כבר התחיל!');
                        return;
                    }
                    
                    const playerCount = Object.keys(existingGame.players || {}).length;
                    console.log(`👥 שחקנים נוכחיים: ${playerCount}/${existingGame.settings.playerCount}`);
                    
                    if (playerCount >= existingGame.settings.playerCount) {
                        console.error('❌ השולחן מלא!');
                        alert('השולחן מלא!');
                        return;
                    }

                    console.log('➕ מוסיף שחקן לשולחן...');
                    await database.ref(`games/${gameId}/players/${newPlayerId}`).set({
                        id: newPlayerId,
                        name: playerName,
                        totalScore: 0,
                        eliminated: false,
                        lastRoll: null,
                        isHost: false,
                        joinedAt: Date.now()
                    });
                    
                    console.log('✅ שחקן נוסף בהצלחה!');

                    setPlayerId(newPlayerId);
                    gameRef.current = database.ref(`games/${gameId}`);
                    setScreen('waiting');
                    
                } catch (error) {
                    console.error('❌ שגיאה בהתחברות:', error);
                    alert('שגיאה בהתחברות לשולחן: ' + error.message);
                }
            };

            // Firebase listener for game updates
            useEffect(() => {
                if (gameId && gameRef.current) {
                    const unsubscribe = gameRef.current.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            console.log('עדכון מ-Firebase:', data);
                            setPlayers(Object.values(data.players || {}));
                            setGameSettings(data.settings || { playerCount: 2, gameType: 1 });
                            
                            // Auto start game when table is full
                            const currentPlayers = Object.keys(data.players || {}).length;
                            console.log(`שחקנים: ${currentPlayers}/${data.settings.playerCount}`);
                            
                            if (data.status === 'waiting' && currentPlayers >= data.settings.playerCount) {
                                console.log('מתחיל משחק - שולחן מלא!');
                                database.ref(`games/${gameId}/status`).set('playing');
                                setScreen('game');
                            } else if (data.status === 'playing') {
                                console.log('משחק פעיל - עובר למסך משחק');
                                setScreen('game');
                            }
                        }
                    });

                    return () => gameRef.current.off('value', unsubscribe);
                }
            }, [gameId]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-800 to-green-900 flex items-center justify-center p-4" dir="rtl">
                    {/* Welcome Screen */}
                    {screen === 'welcome' && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h1 className="text-4xl font-bold text-green-800 mb-6">🎲</h1>
                            <h2 className="text-3xl font-bold text-gray-800 mb-8">משחק הקוביות של נועם</h2>
                            
                            <div className="space-y-4">
                                <input 
                                    type="text"
                                    placeholder="הכנס את שמך"
                                    value={playerName}
                                    onChange={(e) => setPlayerName(e.target.value)}
                                    className="w-full p-3 border rounded-lg text-center text-lg"
                                />
                                
                                <button 
                                    onClick={() => setScreen('setup')}
                                    disabled={!playerName.trim()}
                                    className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg text-xl w-full transition-colors"
                                >
                                    צור שולחן חדש
                                </button>
                                
                                <div className="text-gray-500 font-bold">או</div>
                                
                                <input 
                                    type="text"
                                    placeholder="קוד שולחן (9 תווים)"
                                    value={gameId}
                                    onChange={(e) => setGameId(e.target.value.toLowerCase())}
                                    className="w-full p-3 border rounded-lg text-center text-lg font-mono"
                                    maxLength={9}
                                />
                                
                                <button 
                                    onClick={() => {
                                        console.log('נלחץ הצטרף לשולחן', { playerName, gameId });
                                        joinGame();
                                    }}
                                    disabled={!playerName.trim() || gameId.trim().length < 5}
                                    className={`w-full font-bold py-3 px-6 rounded-lg text-lg transition-colors ${
                                        (!playerName.trim() || gameId.trim().length < 5) 
                                            ? 'bg-gray-400 cursor-not-allowed text-white' 
                                            : 'bg-blue-600 hover:bg-blue-700 text-white'
                                    }`}
                                >
                                    הצטרף לשולחן
                                </button>
                                
                                {/* Debug info */}
                                <div className="text-xs text-gray-500 mt-2">
                                    שם: {playerName || 'ריק'} | קוד: {gameId || 'ריק'} ({gameId.length} תווים)
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Setup Screen */}
                    {screen === 'setup' && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">הגדרת שולחן חדש</h2>
                            <p className="text-lg text-gray-600 mb-6">שלום {playerName}!</p>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-gray-700 font-bold mb-2">כמות שחקנים</label>
                                    <select 
                                        value={gameSettings.playerCount}
                                        onChange={(e) => setGameSettings({...gameSettings, playerCount: parseInt(e.target.value)})}
                                        className="w-full p-3 border rounded-lg text-center text-lg"
                                    >
                                        {[2,3,4,5,6,7,8,9].map(n => (
                                            <option key={n} value={n}>{n} שחקנים</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-gray-700 font-bold mb-2">סוג משחק</label>
                                    <select 
                                        value={gameSettings.gameType}
                                        onChange={(e) => setGameSettings({...gameSettings, gameType: parseInt(e.target.value)})}
                                        className="w-full p-3 border rounded-lg text-center text-lg"
                                    >
                                        <option value={1}>שחקן מול שחקן (עם הדחה)</option>
                                        <option value={2}>5 סיבובים (ללא הדחה)</option>
                                    </select>
                                </div>
                                
                                <button 
                                    onClick={() => {
                                        console.log('🔧 בודק חיבור Firebase...');
                                        console.log('Database object:', database);
                                        console.log('Firebase apps:', firebase.apps);
                                        createGame();
                                    }}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg w-full transition-colors"
                                >
                                    צור שולחן
                                </button>
                                
                                <button 
                                    onClick={() => setScreen('welcome')}
                                    className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg w-full transition-colors"
                                >
                                    חזור
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Waiting Screen */}
                    {screen === 'waiting' && (
                        <div className="text-center bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">ממתין לשחקנים</h2>
                            
                            <div className="bg-gray-100 p-4 rounded-lg mb-4">
                                <p className="text-sm text-gray-600 mb-2">קוד השולחן:</p>
                                <p className="text-2xl font-mono font-bold text-green-600">{gameId}</p>
                                <p className="text-xs text-gray-500 mt-2">שתף את הקוד עם שחקנים אחרים</p>
                            </div>
                            
                            <div className="mb-6">
                                <p className="text-lg font-bold mb-2">
                                    שחקנים: {players.length}/{gameSettings.playerCount}
                                </p>
                                <div className="space-y-2">
                                    {players.map((player, index) => (
                                        <div key={player.id} className="flex items-center justify-center gap-2">
                                            <span className="text-2xl">🎮</span>
                                            <span className="font-medium">{player.name}</span>
                                            {player.isHost && <span className="text-xs bg-yellow-200 px-2 py-1 rounded">מארח</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="text-sm text-gray-600 mb-4">
                                {players.length < gameSettings.playerCount ? (
                                    <>ממתין לעוד {gameSettings.playerCount - players.length} שחקנים...</>
                                ) : (
                                    <span className="text-green-600 font-bold">מתחיל משחק...</span>
                                )}
                            </div>
                            
                            <button
                                onClick={() => setScreen('welcome')}
                                className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors"
                            >
                                🗑️ מחק שולחן
                            </button>
                        </div>
                    )}

                    {/* Game Screen */}
                    {screen === 'game' && (
                        <div className="w-full max-w-4xl mx-auto text-center">
                            <div className="bg-white rounded-xl p-8 shadow-2xl">
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">🎲 המשחק התחיל! 🎲</h2>
                                <p className="text-xl text-gray-600 mb-4">שחקנים במשחק:</p>
                                <div className="space-y-2 mb-6">
                                    {players.map((player, index) => (
                                        <div key={player.id} className="flex items-center justify-center gap-2 text-lg">
                                            <span>🎮</span>
                                            <span className="font-bold">{player.name}</span>
                                            {player.isHost && <span className="text-xs bg-yellow-200 px-2 py-1 rounded">מארח</span>}
                                        </div>
                                    ))}
                                </div>
                                <p className="text-lg text-gray-600">
                                    סוג משחק: {gameSettings.gameType === 1 ? 'עם הדחה' : '5 סיבובים'}
                                </p>
                                <button
                                    onClick={() => setScreen('welcome')}
                                    className="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                                >
                                    חזור לבית
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(React.createElement(DiceGame), document.getElementById('root'));
    </script>
</body>
</html>
